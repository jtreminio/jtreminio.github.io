<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"> <meta name="description" content="Juan Treminio - Dallas based senior web developer"> <meta name="keywords" content=""> <meta property="og:title" content="Running Docker Containers as Current Host User - Juan Treminio - Senior Web Developer Blog"> <meta property="og:type" content="article"> <meta property="og:description" content="ed: If you want to jump right to the solution, jump ahead to Ok so what actually works?. "> <meta property="article:tag" content="docker"> <meta property="og:url" content="https://jtreminio.com/blog/running-docker-containers-as-current-host-user"> <meta property="og:site_name" content="Juan Treminio - Senior Web Developer Blog"> <title>Running Docker Containers as Current Host User - Juan Treminio - Senior Web Developer Blog</title> <link rel="shortcut icon" type="image/png" href="/static/favicon/favicon.ico"/> <link rel="shortcut icon" type="image/png" href="/static/favicon/favicon-96x96.png" sizes="96x96"/> <link rel="shortcut icon" type="image/png" href="/static/favicon/favicon-32x32.png" sizes="32x32"/> <link rel="canonical" href="https://jtreminio.com/blog/running-docker-containers-as-current-host-user"> <link href="//cdn.jsdelivr.net/npm/bootstrap-no-fonts-no-js@3.3.7/css/bootstrap.min.css" rel="stylesheet" type="text/css"/> <link href="//cdnjs.cloudflare.com/ajax/libs/startbootstrap-clean-blog/3.3.7/css/clean-blog.min.css" rel="stylesheet" type="text/css"/> <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/> <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/> <script src="//cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script> <link rel="stylesheet" href="/static/css/rouge.css"/> <link rel="stylesheet" href="/static/css/custom.css?1643036962"/> <link rel="stylesheet" href="/static/css/dark.css?1643036962" data-dark-style/> </head> <body> <nav class="navbar navbar-default navbar-expand-md navbar-custom navbar-fixed-top is-fixed is-visible"> <div class="container-fluid"> <div class="navbar-header page-scroll"> <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar-collapse"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand hidden-xs hidden-sm" href="/">Juan Treminio - Senior Web Developer Blog</a> <a class="navbar-brand visible-xs visible-sm" href="/">Juan Treminio - Developer Blog</a> </div> <div class="collapse navbar-collapse" id="main-navbar-collapse"> <ul class="nav navbar-nav navbar-right"> <li><a href="/">Blog</a></li> <li><a href="/about">About</a></li> <li><a href="/hire-me">Hire Me</a></li> <li> <a class="btn theme-toggle"> <span class="theme-dark"><i data-feather="moon"></i> Dark Theme</span> <span class="theme-light"><i data-feather="sun"></i> Light Theme</span> </a> </li> </ul> </div> </div> </nav> <header class="intro-header"> <div class="container"> <div class="row"> <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"> <div class="post-heading"> <h1>Running Docker Containers as Current Host User</h1> <h2 class="subheading">Making local development less aggravating</h2> <span class="meta">Posted on Aug 05, 2018 <br/> <i class="feather icon-tag"></i>Tags <a href="/tags#docker">docker</a> </span> </div> </div> </div> </div> </header> <article> <div class="container"> <div class="row"> <div class="post col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"> <p><em>ed: If you want to jump right to the solution, jump ahead to <strong><a href="#ok-so-what-actually-works">Ok so what actually works?</a></strong>.</em></p> <p>Docker is an excellent tool for local web development. It allows creating non-trivial environments without polluting the local system with tools.</p> <p>There are still some things that make working with it just a tad bit harder than necessary.</p> <p>Today’s topic involves running Docker containers using the local host system’s current logged-in user.</p> <h2 id="the-problem">The Problem</h2> <p>You are working on a project that requires Node NPM, PHP Composer or a similar tool that downloads or compiles outside dependencies or assets for you.</p> <p>You do not want to install the language (PHP, Node) locally to run this tool, so you choose to run a Docker container. Here is how it would look like to spin up a container with PHP Composer support:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    jtreminio/php:7.2 composer require psr/log
</pre></td></tr></tbody></table></code></pre></div></div> <p>This starts a temporary container using my <a href="https://hub.docker.com/r/jtreminio/php/">PHP 7.2 image</a> that has Composer pre-installed and runs <code class="language-plaintext highlighter-rouge">composer require psr/log</code>.</p> <p>It generates the following:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 20K
drwxrwxr-x. 3 jtreminio jtreminio 4.0K Aug  4 19:34 ./
drwxr-xr-x. 7 jtreminio jtreminio 4.0K Aug  4 19:31 ../
drwxr-xr-x. 4 root      root      4.0K Aug  4 19:34 vendor/
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 root      root        53 Aug  4 19:34 composer.json
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 root      root      2.1K Aug  4 19:34 composer.lock
</pre></td></tr></tbody></table></code></pre></div></div> <p>Although it <em>works</em> as intended, the problem is that the directories and files generated by Composer are root-owned.</p> <p>Since I do not use root, attempting to do anything other than read the files is blocked:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">''</span> <span class="o">&gt;</span> composer.json 
bash: composer.json: Permission denied
</pre></td></tr></tbody></table></code></pre></div></div> <p>You have to <code class="language-plaintext highlighter-rouge">sudo</code> to edit or remove everything. This quickly gets old when your project uses Composer, Webpack, Yarn, etc because your system becomes littered with root-owned files and directories.</p> <h2 id="the-reason">The Reason</h2> <p>Docker on Linux runs as a daemon. The official installation instructions recommend installing as root and selectively adding users to the <code class="language-plaintext highlighter-rouge">docker</code> group so they can run all Docker commands.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>ps <span class="nt">-fe</span> | <span class="nb">grep </span>dockerd
255:root      2356     1  0 Aug03 ?        00:04:06 /usr/bin/dockerd
</pre></td></tr></tbody></table></code></pre></div></div> <p>When you create a new container it does not get created as your current user, but as root, which the daemon is running under.</p> <p>We can verify that the container runs as <code class="language-plaintext highlighter-rouge">root</code> with user/group ID <code class="language-plaintext highlighter-rouge">0:0</code>:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    jtreminio/php:7.2 <span class="nb">whoami
</span>root
</pre></td></tr></tbody></table></code></pre></div></div> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    jtreminio/php:7.2 <span class="se">\</span>
        bash <span class="nt">-c</span> <span class="s2">"echo </span><span class="se">\$</span><span class="s2">(id -u </span><span class="se">\$</span><span class="s2">{USER}):</span><span class="se">\$</span><span class="s2">(id -g </span><span class="se">\$</span><span class="s2">{USER})"</span>
0:0
</pre></td></tr></tbody></table></code></pre></div></div> <h2 id="so-run-as-your-local-user-right">So run as your local user, right?</h2> <p>When you run Docker containers you can specify a user ID, plus a group ID. It is easy enough to do:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    <span class="nt">-u</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span> <span class="se">\</span>
    jtreminio/php:7.2 composer require psr/log
</pre></td></tr></tbody></table></code></pre></div></div> <p>This generates the following:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 20K
drwxrwxr-x. 3 jtreminio jtreminio 4.0K Aug  4 20:09 ./
drwxr-xr-x. 7 jtreminio jtreminio 4.0K Aug  4 19:31 ../
drwxr-xr-x. 4 jtreminio jtreminio 4.0K Aug  4 20:09 vendor/
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 jtreminio jtreminio   53 Aug  4 20:09 composer.json
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 jtreminio jtreminio 2.1K Aug  4 20:09 composer.lock
</pre></td></tr></tbody></table></code></pre></div></div> <blockquote class="info"> <p>In my system, my user <code class="language-plaintext highlighter-rouge">jtreminio</code> has user ID <code class="language-plaintext highlighter-rouge">1000</code> and group ID <code class="language-plaintext highlighter-rouge">1000</code>, so the new line</p> <p><code class="language-plaintext highlighter-rouge">-u $(id -u ${USER}):$(id -g ${USER})</code></p> <p>gets interpreted as</p> <p><code class="language-plaintext highlighter-rouge">-u 1000:1000</code></p> </blockquote> <p>This does exactly what we want, but of course there is a catch: the container user is no longer root, or whatever the author decided to use. On Composer and NPM this simply means any internal cache directories cannot be written to since they are root-owned, but that really is not much of a problem because we are tearing the containers down as soon as they finish running what we told them to.</p> <p>The Composer container above is deleted as soon as <code class="language-plaintext highlighter-rouge">composer require psr/log</code> finishes executing.</p> <p>What if you want to run a web app with PHP-FPM? It must be able to create its PID file at <code class="language-plaintext highlighter-rouge">/var/run/php-fpm.pid</code>, if you are using file-based sessions it must write to <code class="language-plaintext highlighter-rouge">/var/lib/php/sessions</code>. Any number of things that require root or a predefined user will no longer work because the container is <em>running using your user/group ID</em>:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    <span class="nt">-u</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span> <span class="se">\</span>
    jtreminio/php:7.2 <span class="nb">whoami
whoami</span>: cannot find name <span class="k">for </span>user ID 1000
</pre></td></tr></tbody></table></code></pre></div></div> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    <span class="nt">-u</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span> <span class="se">\</span>
    jtreminio/php:7.2 <span class="se">\</span>
        bash <span class="nt">-c</span> <span class="s2">"echo </span><span class="se">\$</span><span class="s2">(id -u </span><span class="se">\$</span><span class="s2">{USER}):</span><span class="se">\$</span><span class="s2">(id -g </span><span class="se">\$</span><span class="s2">{USER})"</span>
1000:1000
</pre></td></tr></tbody></table></code></pre></div></div> <p>If you try to do anything that requires elevated permissions or a specific user, you will be denied:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    <span class="nt">-u</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span> <span class="se">\</span>
    jtreminio/php:7.2 <span class="nb">ls</span> <span class="nt">-la</span> /var/lib/php/sessions
total 8
drwxr-xr-x. 1 www-data www-data 4096 Jul  9 12:35 <span class="nb">.</span>
drwxr-xr-x. 1 root     root     4096 Jul 26 09:08 ..
</pre></td></tr></tbody></table></code></pre></div></div> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    <span class="nt">-u</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span> <span class="se">\</span>
    jtreminio/php:7.2 <span class="nb">touch</span> /var/lib/php/sessions/foo
<span class="nb">touch</span>: cannot <span class="nb">touch</span> <span class="s1">'/var/lib/php/sessions/foo'</span>: Permission denied
</pre></td></tr></tbody></table></code></pre></div></div> <p>The above means running the PHP-FPM daemon as your local user will quickly encounter permissions issues. In this case it is because <code class="language-plaintext highlighter-rouge">/var/lib/php/sessions</code> is owned by <code class="language-plaintext highlighter-rouge">www-data:www-data</code> which most likely does not share your local user’s IDs:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    jtreminio/php:7.2 <span class="se">\</span>
        bash <span class="nt">-c</span> <span class="s2">"echo </span><span class="se">\$</span><span class="s2">(id -u www-data):</span><span class="se">\$</span><span class="s2">(id -g www-data)"</span>
33:33
</pre></td></tr></tbody></table></code></pre></div></div> <h2 id="ok-run-it-as-an-non-root-internal-user">OK, run it as an non-root internal user?</h2> <p>So far we have found that</p> <ul> <li>root works great inside the container but is annoying to work with on the host system, and</li> <li>your local user works great on your host system, but will quickly run into permission problems inside the container.</li> </ul> <p>What if we try to run the containers as a non-root user that has required permissions to write inside the container directories?</p> <p>Try with the container’s internal <code class="language-plaintext highlighter-rouge">www-data</code> user:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    <span class="nt">-u</span> www-data <span class="se">\</span>
    jtreminio/php:7.2 <span class="se">\</span>
        bash <span class="nt">-c</span> <span class="s2">"touch /var/lib/php/sessions/foo &amp;&amp; echo </span><span class="se">\$</span><span class="s2">?"</span>
0
</pre></td></tr></tbody></table></code></pre></div></div> <p>As expected this worked fine, but if you try running Composer:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    <span class="nt">-u</span> www-data <span class="se">\</span>
    jtreminio/php:7.2 composer require psr/log

<span class="o">[</span>ErrorException]                                                              
file_put_contents<span class="o">(</span>./composer.json<span class="o">)</span>: failed to open stream: Permission denied  
</pre></td></tr></tbody></table></code></pre></div></div> <p>The problem is that the internal container user <code class="language-plaintext highlighter-rouge">www-data</code> with user/group ID <code class="language-plaintext highlighter-rouge">33:33</code>, does not have write permissions to my host’s current directory:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 8.0K
drwxrwxr-x. 2 jtreminio jtreminio 4.0K Aug  4 20:34 ./
drwxr-xr-x. 7 jtreminio jtreminio 4.0K Aug  4 19:31 ../
</pre></td></tr></tbody></table></code></pre></div></div> <p>We might as well add another grievance to our list:</p> <ul> <li>non-root internal user with required permissions works great inside the container but completely falters on host system with volumes.</li> </ul> <h2 id="why-is-this-happening">Why is this happening?</h2> <p>Host and containers do not share users and groups.</p> <p>On my local system, there is no <code class="language-plaintext highlighter-rouge">www-data</code> user:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">groups </span>www-data
<span class="nb">groups</span>: ‘www-data’: no such user
</pre></td></tr></tbody></table></code></pre></div></div> <p>Similarly, if I try using my direct username to run the container I see errors:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    <span class="nt">-u</span> jtreminio <span class="se">\</span>
    jtreminio/php:7.2 <span class="nb">whoami
</span>docker: Error response from daemon: linux spec user: unable to find user jtreminio: no matching entries <span class="k">in </span>passwd file.
</pre></td></tr></tbody></table></code></pre></div></div> <p>As far as the container is aware, it is its own separate system with its own list of users at <code class="language-plaintext highlighter-rouge">/etc/passwd</code> and list of groups at <code class="language-plaintext highlighter-rouge">/etc/group</code>. It has no idea about any users or groups that exist on the host system. Likewise, the host does not know about users in the container. By convention root is <code class="language-plaintext highlighter-rouge">0:0</code> which will match any Linux system, but anything else is up to each distro and each image author.</p> <h2 id="try-sharing-etcpasswd">Try sharing <code class="language-plaintext highlighter-rouge">/etc/passwd</code>!</h2> <p>Now we know that the</p> <ul> <li>host system does not know about container’s <code class="language-plaintext highlighter-rouge">/etc/passwd</code>, and</li> <li>container does not know about the host system’s <code class="language-plaintext highlighter-rouge">/etc/passwd</code></li> </ul> <p>What happens if we bind the host’s <code class="language-plaintext highlighter-rouge">/etc/passwd</code> to the container’s?</p> <p>Not much as you would think, actually. My host system still does not have a user matching <code class="language-plaintext highlighter-rouge">33:33</code>, so even if I bind the <code class="language-plaintext highlighter-rouge">/etc/passwd</code> into the container, attempting to write to <code class="language-plaintext highlighter-rouge">www-data</code>-owned directories still will not work.</p> <p>This is because Linux permissions are not name-based, but ID-based.</p> <p>For example, on my local system:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lan</span>
total 8.0K
drwxrwxr-x. 2 1000 1000 4.0K Aug  4 20:34 ./
drwxr-xr-x. 7 1000 1000 4.0K Aug  4 19:31 ../
</pre></td></tr></tbody></table></code></pre></div></div> <p>and in the container:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    <span class="nt">-u</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span> <span class="se">\</span>
    jtreminio/php:7.2 <span class="nb">ls</span> <span class="nt">-lan</span> /var/lib/php/sessions
total 8
drwxr-xr-x. 1 33 33 4096 Jul  9 12:35 <span class="nb">.</span>
drwxr-xr-x. 1  0  0 4096 Jul 26 09:08 ..
</pre></td></tr></tbody></table></code></pre></div></div> <p>In the container <code class="language-plaintext highlighter-rouge">www-data:www-data</code> is simply an alias to <code class="language-plaintext highlighter-rouge">33:33</code>.</p> <h2 id="user-namespaces">User namespaces</h2> <p>The container does not care what user and group name is used, it simply wants the IDs to match.</p> <p>There is a concept in Docker Engine called <em>User Namespaces</em>. <a href="https://www.jujens.eu/posts/en/2017/Jul/02/docker-userns-remap/">Here is a great introduction to them.</a></p> <p>The concept boils down to mapping the internal container user/group IDs to reflect different values.</p> <p>For example, you can tell Docker to use your current user/group ID as the “floor” for container IDs. In my example, my <code class="language-plaintext highlighter-rouge">jtreminio</code> account with <code class="language-plaintext highlighter-rouge">1000:1000</code> would map directly to <code class="language-plaintext highlighter-rouge">0:0</code> in a container.</p> <p>In other words, we tell Docker to consider our current user on the host as root in containers! Local system user ID <code class="language-plaintext highlighter-rouge">1000</code> maps directly to container user ID <code class="language-plaintext highlighter-rouge">0</code>.</p> <p>User namespaces would allow us to run all containers as root internally which would completely eliminate any permission issues, and any generated files and directories on shared volumes would be owned by the host user/group so we would no longer need to <code class="language-plaintext highlighter-rouge">sudo</code> to edit or delete them.</p> <p>This sounds exactly what we need, right? There is a catch (because of course there is)… in fact, multiple catches!</p> <h4 id="you-are-running-the-container-as-root">You are running the container as root</h4> <p>Normally this would be a security concern. Countless articles and guides strongly recommend <em>not</em> running as root in containers.</p> <p>In this case, this is not the problem, because the container’s internal root maps to our current, non-root user on host.</p> <p>The problem actually comes down to root being able to do anything and everything in the container, which opens the door to unforeseen permissions issues when you deploy to production, where you would not be using user namespaces.</p> <p>In production, most containers will run as non-root, with permissions specifically tailored for that user/group ID. Attempting to do anything the user is not permitted will rightfully result in permissions denied errors. This is a safety feature you <em>want</em>, and running as root completely ignores this.</p> <p>You might run as root on your local system and everything works perfectly fine. You are happy, files are generated as expected, all actions are permitted and you are a happy developer. Once you deploy to production you may suddenly realize that you were developing on a system very much unlike production. Something that worked flawlessly on your development system can easily break on production due to insufficient permissions for whatever user is running the container service.</p> <h4 id="your-usergroup-id-is-the-floor-it-goes-up">Your user/group ID is the <em>floor</em>, it goes up!</h4> <p>Your user/group ID maps directly to <code class="language-plaintext highlighter-rouge">0:0</code> in the container, but there are more accounts than just the one root and none of them are mapped to your host user.</p> <p>This means that while <code class="language-plaintext highlighter-rouge">0:0</code> maps to my host system’s <code class="language-plaintext highlighter-rouge">1000:1000</code>, the container’s <code class="language-plaintext highlighter-rouge">www-data</code> user with IDs <code class="language-plaintext highlighter-rouge">33:33</code> would map to my host system’s <code class="language-plaintext highlighter-rouge">1033:1033</code>, which does not exist.</p> <p>Anything done as non-root in the container will run against the same issues we saw earlier: what might be considered sufficient permissions inside the container will probably not work the same on your host.</p> <p>My host’s directories are still owned by <code class="language-plaintext highlighter-rouge">1000:1000</code> and a user with <code class="language-plaintext highlighter-rouge">1033:1033</code> will be denied.</p> <h4 id="all-containers-on-your-system-are-affected">All containers on your system are affected</h4> <p>If the previous two reasons are not enough, the fact that Docker does not come with User Namespaces support enabled by default, to enable it requires editing a JSON config file and restarting the Docker daemon, and now all your existing and future containers will implement namespaces whether you want them to or not should be enough to make you question if it is worth the hassle.</p> <h2 id="ok-so-what-actually-works">Ok so what actually works?</h2> <p>The only sure-fire way of resolving all previous issues and getting on with Making the World a Better Place is completely replacing the internal user/group IDs with known, good values.</p> <p>In the container, <code class="language-plaintext highlighter-rouge">www-data</code> maps to <code class="language-plaintext highlighter-rouge">33:33</code>. Why not change it so it maps to my host system’s <code class="language-plaintext highlighter-rouge">jtreminio</code> with <code class="language-plaintext highlighter-rouge">1000:1000</code>?</p> <p>In other words, make the container’s <code class="language-plaintext highlighter-rouge">www-data</code> user/group ID be <code class="language-plaintext highlighter-rouge">1000:1000</code>.</p> <p>You cannot change an existing account’s user/group IDs. Remember, the user and group names are simply aliases to the IDs. You can <em>rename</em> <code class="language-plaintext highlighter-rouge">www-data</code> to anything you want but the IDs will not change.</p> <p>The only thing you can do is <em>delete</em> and <em>recreate</em> the user/group completely.</p> <p>For this we will need to create a Dockerfile. We need to recreate the user before any potential entrypoint scripts are run. Unknown issues can and will occur if you attempt to delete a user/group while it is in use by another process.</p> <p>First, delete the user and group:</p> <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> jtreminio/php:7.2</span>

<span class="k">RUN </span>userdel <span class="nt">-f</span> www-data <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="k">if </span>getent group www-data <span class="p">;</span> <span class="k">then </span>groupdel www-data<span class="p">;</span> <span class="k">fi</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>We test if the group actually exists before trying to delete, to avoid possible errors when the group does not exist.</p> <p>Next, we can generate the user and group with our IDs:</p> <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> jtreminio/php:7.2</span>

<span class="k">ARG</span><span class="s"> USER_ID=1000</span>
<span class="k">ARG</span><span class="s"> GROUP_ID=1000</span>

<span class="k">RUN </span>userdel <span class="nt">-f</span> www-data <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="k">if </span>getent group www-data <span class="p">;</span> <span class="k">then </span>groupdel www-data<span class="p">;</span> <span class="k">fi</span> <span class="o">&amp;&amp;</span><span class="se">\
</span>    groupadd <span class="nt">-g</span> <span class="k">${</span><span class="nv">GROUP_ID</span><span class="k">}</span> www-data <span class="o">&amp;&amp;</span><span class="se">\
</span>    useradd <span class="nt">-l</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">USER_ID</span><span class="k">}</span> <span class="nt">-g</span> www-data www-data <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="nb">install</span> <span class="nt">-d</span> <span class="nt">-m</span> 0755 <span class="nt">-o</span> www-data <span class="nt">-g</span> www-data /home/www-data
</pre></td></tr></tbody></table></code></pre></div></div> <p>After we delete the user and group, we recreate it with the defined values.</p> <p><code class="language-plaintext highlighter-rouge">1000</code> is my user and group ID, and now the container’s <code class="language-plaintext highlighter-rouge">www-data</code> has the same.</p> <blockquote class="danger"> <p>Remember to use the <code class="language-plaintext highlighter-rouge">-l</code> flag with <code class="language-plaintext highlighter-rouge">useradd</code>! There is an amazingly fun issue where a high UID value will generate huge log files and freeze your system! <a href="https://github.com/moby/moby/issues/5419">Click here for all the juicy details</a>.</p> </blockquote> <p>We also take the time to generate a home directory for our new user. This makes it much easier to have your container perform SSH actions using your host’s SSH keys as long as you bind a volume.</p> <p>Even though we are done with recreating the user and group, there is a problem: Any files and directories that were owned by the <code class="language-plaintext highlighter-rouge">www-data</code> user will not automatically point to the new ID values. Since the names are just <em>labels</em>, <code class="language-plaintext highlighter-rouge">/var/lib/php/sessions</code> is still owned by <code class="language-plaintext highlighter-rouge">33:33</code>, not matching our spiffy new <code class="language-plaintext highlighter-rouge">1000:1000</code>!</p> <p>This is the part where you need to know just enough about the container you want to run that you can pinpoint which files and directories you need to update the owner for.</p> <p>Thankfully, the rallying cry of containers is to have them do one single thing, which limits the number of places we need to update. In this image, it is not very many at all:</p> <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> jtreminio/php:7.2</span>

<span class="k">ARG</span><span class="s"> USER_ID=1000</span>
<span class="k">ARG</span><span class="s"> GROUP_ID=1000</span>

<span class="k">RUN </span>userdel <span class="nt">-f</span> www-data <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="k">if </span>getent group www-data <span class="p">;</span> <span class="k">then </span>groupdel www-data<span class="p">;</span> <span class="k">fi</span> <span class="o">&amp;&amp;</span><span class="se">\
</span>    groupadd <span class="nt">-g</span> <span class="k">${</span><span class="nv">GROUP_ID</span><span class="k">}</span> www-data <span class="o">&amp;&amp;</span><span class="se">\
</span>    useradd <span class="nt">-l</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">USER_ID</span><span class="k">}</span> <span class="nt">-g</span> www-data www-data <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="nb">install</span> <span class="nt">-d</span> <span class="nt">-m</span> 0755 <span class="nt">-o</span> www-data <span class="nt">-g</span> www-data /home/www-data <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="nb">chown</span> <span class="nt">--changes</span> <span class="nt">--silent</span> <span class="nt">--no-dereference</span> <span class="nt">--recursive</span> <span class="se">\
</span>          <span class="nt">--from</span><span class="o">=</span>33:33 <span class="k">${</span><span class="nv">USER_ID</span><span class="k">}</span>:<span class="k">${</span><span class="nv">GROUP_ID</span><span class="k">}</span> <span class="se">\
</span>        /home/www-data <span class="se">\
</span>        /.composer <span class="se">\
</span>        /var/run/php-fpm <span class="se">\
</span>        /var/lib/php/sessions
</pre></td></tr></tbody></table></code></pre></div></div> <p>You can figure out what you need by looking at the Dockerfile used to generate the image. For the <a href="https://github.com/jtreminio/php-docker/blob/master/php7.2/Dockerfile"><code class="language-plaintext highlighter-rouge">jtreminio/php:7.2</code></a> image we can see that <code class="language-plaintext highlighter-rouge">/.composer</code>, <code class="language-plaintext highlighter-rouge">/var/run/php-fpm</code> and <code class="language-plaintext highlighter-rouge">/var/lib/php/sessions</code> directories need updated.</p> <p>Finally, it does not hurt to be explicit about the user we want to run the container:</p> <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> jtreminio/php:7.2</span>

<span class="k">ARG</span><span class="s"> USER_ID=1000</span>
<span class="k">ARG</span><span class="s"> GROUP_ID=1000</span>

<span class="k">RUN </span>userdel <span class="nt">-f</span> www-data <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="k">if </span>getent group www-data <span class="p">;</span> <span class="k">then </span>groupdel www-data<span class="p">;</span> <span class="k">fi</span> <span class="o">&amp;&amp;</span><span class="se">\
</span>    groupadd <span class="nt">-g</span> <span class="k">${</span><span class="nv">GROUP_ID</span><span class="k">}</span> www-data <span class="o">&amp;&amp;</span><span class="se">\
</span>    useradd <span class="nt">-l</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">USER_ID</span><span class="k">}</span> <span class="nt">-g</span> www-data www-data <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="nb">install</span> <span class="nt">-d</span> <span class="nt">-m</span> 0755 <span class="nt">-o</span> www-data <span class="nt">-g</span> www-data /home/www-data <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="nb">chown</span> <span class="nt">--changes</span> <span class="nt">--silent</span> <span class="nt">--no-dereference</span> <span class="nt">--recursive</span> <span class="se">\
</span>          <span class="nt">--from</span><span class="o">=</span>33:33 <span class="k">${</span><span class="nv">USER_ID</span><span class="k">}</span>:<span class="k">${</span><span class="nv">GROUP_ID</span><span class="k">}</span> <span class="se">\
</span>        /home/www-data <span class="se">\
</span>        /.composer <span class="se">\
</span>        /var/run/php-fpm <span class="se">\
</span>        /var/lib/php/sessions
        
<span class="k">USER</span><span class="s"> www-data</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>If you run the container now, you will automatically become the <code class="language-plaintext highlighter-rouge">www-data</code> user which now has user/group ID <code class="language-plaintext highlighter-rouge">1000:1000</code>. Any files generated by this container will be owned by my host system’s user.</p> <p>What should we do about the hard-coded IDs, though? Your coworkers may have different IDs on their machines.</p> <h2 id="make-it-dynamic">Make it dynamic</h2> <p>You can pass arguments when building an image using <code class="language-plaintext highlighter-rouge">--build-arg</code>.</p> <p>Update the Dockerfile first:</p> <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> jtreminio/php:7.2</span>

<span class="k">ARG</span><span class="s"> USER_ID</span>
<span class="k">ARG</span><span class="s"> GROUP_ID</span>

<span class="k">RUN if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">USER_ID</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span> <span class="nt">-ne</span> 0 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="k">${</span><span class="nv">GROUP_ID</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span> <span class="nt">-ne</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="se">\
</span>    userdel <span class="nt">-f</span> www-data <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="k">if </span>getent group www-data <span class="p">;</span> <span class="k">then </span>groupdel www-data<span class="p">;</span> <span class="k">fi</span> <span class="o">&amp;&amp;</span><span class="se">\
</span>    groupadd <span class="nt">-g</span> <span class="k">${</span><span class="nv">GROUP_ID</span><span class="k">}</span> www-data <span class="o">&amp;&amp;</span><span class="se">\
</span>    useradd <span class="nt">-l</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">USER_ID</span><span class="k">}</span> <span class="nt">-g</span> www-data www-data <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="nb">install</span> <span class="nt">-d</span> <span class="nt">-m</span> 0755 <span class="nt">-o</span> www-data <span class="nt">-g</span> www-data /home/www-data <span class="o">&amp;&amp;</span><span class="se">\
</span>    <span class="nb">chown</span> <span class="nt">--changes</span> <span class="nt">--silent</span> <span class="nt">--no-dereference</span> <span class="nt">--recursive</span> <span class="se">\
</span>          <span class="nt">--from</span><span class="o">=</span>33:33 <span class="k">${</span><span class="nv">USER_ID</span><span class="k">}</span>:<span class="k">${</span><span class="nv">GROUP_ID</span><span class="k">}</span> <span class="se">\
</span>        /home/www-data <span class="se">\
</span>        /.composer <span class="se">\
</span>        /var/run/php-fpm <span class="se">\
</span>        /var/lib/php/sessions <span class="se">\
</span><span class="p">;</span><span class="k">fi</span>
        
<span class="k">USER</span><span class="s"> www-data</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>We make both <code class="language-plaintext highlighter-rouge">USER_ID</code> and <code class="language-plaintext highlighter-rouge">GROUP_ID</code> optional. If both are not defined, we skip the whole user delete/recreate process completely. This Dockerfile can now be used for both dev and production purposes.</p> <p>To build the above image you would do:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>docker image build <span class="se">\</span>
    <span class="nt">--build-arg</span> <span class="nv">USER_ID</span><span class="o">=</span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span> <span class="se">\</span>
    <span class="nt">--build-arg</span> <span class="nv">GROUP_ID</span><span class="o">=</span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span> <span class="se">\</span>
    <span class="nt">-t</span> php_test <span class="se">\</span>
    <span class="nb">.</span>

Sending build context to Docker daemon   68.1kB
Step 1/5 : FROM jtreminio/php:7.2
 <span class="nt">---</span><span class="o">&gt;</span> 88efaa8cad72
Step 2/5 : ARG USER_ID
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>51d424a6d618
Removing intermediate container 51d424a6d618
 <span class="nt">---</span><span class="o">&gt;</span> 3feace11551d
Step 3/5 : ARG GROUP_ID
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>aaaceff5ee4e
Removing intermediate container aaaceff5ee4e
 <span class="nt">---</span><span class="o">&gt;</span> 9f110b0f92c2
Step 4/5 : RUN <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">USER_ID</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span> <span class="nt">-ne</span> 0 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="k">${</span><span class="nv">GROUP_ID</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span> <span class="nt">-ne</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then     </span>userdel <span class="nt">-f</span> www-data <span class="o">&amp;&amp;</span>    <span class="k">if </span>getent group www-data <span class="p">;</span> <span class="k">then </span>groupdel www-data<span class="p">;</span> <span class="k">fi</span> <span class="o">&amp;&amp;</span>    groupadd <span class="nt">-g</span> <span class="k">${</span><span class="nv">GROUP_ID</span><span class="k">}</span> www-data <span class="o">&amp;&amp;</span>    useradd <span class="nt">-l</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">USER_ID</span><span class="k">}</span> <span class="nt">-g</span> www-data www-data <span class="o">&amp;&amp;</span>    <span class="nb">install</span> <span class="nt">-d</span> <span class="nt">-m</span> 0755 <span class="nt">-o</span> www-data <span class="nt">-g</span> www-data /home/www-data <span class="o">&amp;&amp;</span>    <span class="nb">chown</span> <span class="nt">--changes</span> <span class="nt">--silent</span> <span class="nt">--no-dereference</span> <span class="nt">--recursive</span>           <span class="nt">--from</span><span class="o">=</span>33:33 <span class="k">${</span><span class="nv">USER_ID</span><span class="k">}</span>:<span class="k">${</span><span class="nv">GROUP_ID</span><span class="k">}</span>         /home/www-data         /.composer         /var/run/php-fpm         /var/lib/php/sessions <span class="p">;</span><span class="k">fi</span>
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>b516a3ab4600
changed ownership of <span class="s1">'/.composer/keys.tags.pub'</span> from 33:33 to 1000:1000
changed ownership of <span class="s1">'/.composer/keys.dev.pub'</span> from 33:33 to 1000:1000
changed ownership of <span class="s1">'/.composer'</span> from 33:33 to 1000:1000
changed ownership of <span class="s1">'/var/run/php-fpm'</span> from 33:33 to 1000:1000
changed ownership of <span class="s1">'/var/lib/php/sessions'</span> from 33:33 to 1000:1000
Removing intermediate container b516a3ab4600
 <span class="nt">---</span><span class="o">&gt;</span> c126c9f07252
Step 5/5 : USER www-data
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>76831280f239
Removing intermediate container 76831280f239
 <span class="nt">---</span><span class="o">&gt;</span> 5c237c8e46cd
Successfully built 5c237c8e46cd
Successfully tagged php_test:latest
</pre></td></tr></tbody></table></code></pre></div></div> <p>Try running Composer with the new image:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    php_test:latest composer require psr/log
</pre></td></tr></tbody></table></code></pre></div></div> <p>and check out the result:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lan</span>
total 24K
drwxrwxr-x. 3 1000 1000 4.0K Aug  4 22:50 ./
drwxr-xr-x. 7 1000 1000 4.0K Aug  4 19:31 ../
drwxr-xr-x. 4 1000 1000 4.0K Aug  4 22:50 vendor/
<span class="nt">-rw-rw-r--</span><span class="nb">.</span> 1 1000 1000  545 Aug  4 22:48 Dockerfile
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 1000 1000   53 Aug  4 22:50 composer.json
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 1000 1000 2.1K Aug  4 22:50 composer.lock
</pre></td></tr></tbody></table></code></pre></div></div> <p>Try creating a file in a protected directory:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    php_test:latest <span class="se">\</span>
        bash <span class="nt">-c</span> <span class="s2">"touch /var/lib/php/sessions/foo &amp;&amp; echo </span><span class="se">\$</span><span class="s2">?"</span>
0
</pre></td></tr></tbody></table></code></pre></div></div> <h2 id="user-docker-compose">User Docker Compose</h2> <p>You can take the <code class="language-plaintext highlighter-rouge">docker image build</code> command and save it to a bash file for easy execution.</p> <p>However, most folks would rather use Docker Compose for local development.</p> <p>Here is what your <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> might look like:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.2'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">php</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">.</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">Dockerfile</span>
      <span class="na">args</span><span class="pi">:</span>
        <span class="na">USER_ID</span><span class="pi">:</span> <span class="s">$(id -u ${USER})</span>
        <span class="na">GROUP_ID</span><span class="pi">:</span> <span class="s">$(id -g ${USER})</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">${HOME}/.composer:/.composer</span>
      <span class="pi">-</span> <span class="s">${PWD}:/var/www</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">9000:9000</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>Unfortunately, Docker Compose cannot parse commands, so <code class="language-plaintext highlighter-rouge">$(id -u ${USER})</code> would not work in the YAML file. Thankfully we can use <code class="language-plaintext highlighter-rouge">.env</code> file to pass values:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="c1"># docker-compose.yml</span>
<span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.2'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">php</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">.</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">Dockerfile</span>
      <span class="na">args</span><span class="pi">:</span>
        <span class="na">USER_ID</span><span class="pi">:</span> <span class="s">${USER_ID:-0}</span>
        <span class="na">GROUP_ID</span><span class="pi">:</span> <span class="s">${GROUP_ID:-0}</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">${HOME}/.composer:/.composer</span>
      <span class="pi">-</span> <span class="s">${PWD}:/var/www</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">9000:9000</span>
</pre></td></tr></tbody></table></code></pre></div></div> <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="c">; .env
</span><span class="py">USER_ID</span><span class="p">=</span><span class="s">1000</span>
<span class="py">GROUP_ID</span><span class="p">=</span><span class="s">1000</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>With a single <code class="language-plaintext highlighter-rouge">docker-compose up -d --build</code> we are up and running:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>docker-compose up <span class="nt">-d</span> <span class="nt">--build</span>
Creating network <span class="s2">"temp_default"</span> with the default driver
Building php
Step 1/5 : FROM jtreminio/php:7.2
 <span class="nt">---</span><span class="o">&gt;</span> 88efaa8cad72
Step 2/5 : ARG USER_ID
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>1b406c5797aa
Removing intermediate container 1b406c5797aa
 <span class="nt">---</span><span class="o">&gt;</span> c61d4e7b14b9
Step 3/5 : ARG GROUP_ID
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>14ac56de9dc8
Removing intermediate container 14ac56de9dc8
 <span class="nt">---</span><span class="o">&gt;</span> 576ada9d6dbe
Step 4/5 : RUN <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">USER_ID</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span> <span class="nt">-ne</span> 0 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="k">${</span><span class="nv">GROUP_ID</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span> <span class="nt">-ne</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then     </span>userdel <span class="nt">-f</span> www-data <span class="o">&amp;&amp;</span>    <span class="k">if </span>getent group www-data <span class="p">;</span> <span class="k">then </span>groupdel www-data<span class="p">;</span> <span class="k">fi</span> <span class="o">&amp;&amp;</span>    groupadd <span class="nt">-g</span> <span class="k">${</span><span class="nv">GROUP_ID</span><span class="k">}</span> www-data <span class="o">&amp;&amp;</span>    useradd <span class="nt">-l</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">USER_ID</span><span class="k">}</span> <span class="nt">-g</span> www-data www-data <span class="o">&amp;&amp;</span>    <span class="nb">install</span> <span class="nt">-d</span> <span class="nt">-m</span> 0755 <span class="nt">-o</span> www-data <span class="nt">-g</span> www-data /home/www-data <span class="o">&amp;&amp;</span>    <span class="nb">chown</span> <span class="nt">--changes</span> <span class="nt">--silent</span> <span class="nt">--no-dereference</span> <span class="nt">--recursive</span>           <span class="nt">--from</span><span class="o">=</span>33:33 <span class="k">${</span><span class="nv">USER_ID</span><span class="k">}</span>:<span class="k">${</span><span class="nv">GROUP_ID</span><span class="k">}</span>         /home/www-data         /.composer         /var/run/php-fpm         /var/lib/php/sessions <span class="p">;</span><span class="k">fi</span>
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>632e67cdc854
changed ownership of <span class="s1">'/.composer/keys.tags.pub'</span> from 33:33 to 1000:1000
changed ownership of <span class="s1">'/.composer/keys.dev.pub'</span> from 33:33 to 1000:1000
changed ownership of <span class="s1">'/.composer'</span> from 33:33 to 1000:1000
changed ownership of <span class="s1">'/var/run/php-fpm'</span> from 33:33 to 1000:1000
changed ownership of <span class="s1">'/var/lib/php/sessions'</span> from 33:33 to 1000:1000
Removing intermediate container 632e67cdc854
 <span class="nt">---</span><span class="o">&gt;</span> 1bb2e0bbff3c
Step 5/5 : USER www-data
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>8efe4779c454
Removing intermediate container 8efe4779c454
 <span class="nt">---</span><span class="o">&gt;</span> b3bd40096b94
Successfully built b3bd40096b94
Successfully tagged temp_php:latest
Creating temp_php_1 ... <span class="k">done</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>We now have a PHP-FPM container running with my system user/group ID <code class="language-plaintext highlighter-rouge">1000:1000</code> waiting for connections from Nginx or Apache.</p> <h2 id="what-containers-need-this">What containers need this?</h2> <p>Not all containers actually require these steps. For simpler images like the official Nginx or Apache that do not generate files you would be interested in editing while in development, you can skip this and let the container run as the normal internal user.</p> <p>For containers that only fetch dependencies to local disk, like PHP Composer or Node NPM, you can get by with simply passing your user/group ID directly. The container will complain about a user not existing for those values, but will otherwise work fine. Cache directories may need a little bit of work.</p> <p>Containers with long-running daemons that generate a large amount of files, like parsing SCSS to CSS, will benefit you greatly to implement this concept.</p> <h2 id="macos-and-windows-users">MacOS and Windows users…</h2> <p>You do not actually need to do any of this. Like, this whole article, you can skip it. Docker does not actually run natively on either of these operating systems, but transparently in a virtual machine.</p> <p>This virtual machine is run under whatever user installed Docker, which is usually not root on MacOS or administrator on Windows.</p> <p>While <em>you</em> do not need this, it is still a good idea to implement it. Your coworkers that run Linux as their main OS will benefit greatly, and if you ever make the switch you will already have your Docker stuff up to date.</p> <p>You will also only require a single Dockerfile between all your coworkers.</p> <h2 id="wrapping-it-up">Wrapping it up</h2> <p>While you <em>can</em> run all containers as the default internal user, dedicating just a few minutes per image to switch to your user/group ID will help eliminate one fairly big point of frustration.</p> <p>Overall Docker is an amazing technology but little things like this can mar an otherwise enjoyable experience. Knowing how to smooth the bumps will help make Docker’s promise of Nirvana come true.</p> <p>Until next time, this is Señor PHP Developer Juan Treminio wishing you adios!</p> <hr class="invisible"> <ul class="pager"> <li class="previous"> <a href="/blog/traefik-on-docker-for-web-developers" data-toggle="tooltip" data-placement="top" title="Traefik on Docker for Web Developers"> Previous &rarr;<br> <span>Traefik on Docker for Web Developers</span> </a> </li> <li class="next"> <a href="/blog/setting-up-a-static-site-with-hugo-and-push-to-deploy" data-toggle="tooltip" data-placement="top" title="Setting Up a Static Site with Hugo and Push to Deploy"> &larr; Next<br> <span>Setting Up a Static Site with Hugo and Push to Deploy</span> </a> </li> </ul> <hr class="invisible"> <div class="comment"> <script src="//utteranc.es/client.js" repo="jtreminio/jtreminio.github.io" issue-number="14" theme="github-light" crossorigin="anonymous" async></script> </div> </div> </div> </div> </article> <footer> <div class="container"> <div class="row"> <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"> <ul class="list-inline text-center footer-icons"> <li><a href="mailto:jtreminio@gmail.com"><i data-feather="mail"></i></a></li> <li> <a href="https://github.com/jtreminio" target="_blank"> <i data-feather="github"></i> </a> </li> <li> <a href="https://twitter.com/juantreminio" target="_blank"> <i data-feather="twitter"></i> </a> </li> <li> <a href="https://www.linkedin.com/in/jtreminio-1" target="_blank"> <i data-feather="linkedin"></i> </a> </li> </ul> </div> </div> </div> </footer> <link href="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" rel="stylesheet" type="text/css"/> <link href="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" rel="stylesheet" type="text/css"/> <script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js"></script> <script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js"></script> <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"> <div class="pswp__bg"></div> <div class="pswp__scroll-wrap"> <div class="pswp__container"> <div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div> </div> <div class="pswp__ui pswp__ui--hidden"> <div class="pswp__top-bar"> <div class="pswp__counter"></div> <button class="pswp__button pswp__button--close" title="Close (Esc)"></button> <button class="pswp__button pswp__button--share" title="Share"></button> <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button> <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button> <div class="pswp__preloader"> <div class="pswp__preloader__icn"> <div class="pswp__preloader__cut"> <div class="pswp__preloader__donut"></div> </div> </div> </div> </div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"> <div class="pswp__share-tooltip"></div> </div> <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"> </button> <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"> </button> <div class="pswp__caption"> <div class="pswp__caption__center"></div> </div> </div> </div> </div> </body> <script src="/static/js/custom.js?1643036962"></script> </html>