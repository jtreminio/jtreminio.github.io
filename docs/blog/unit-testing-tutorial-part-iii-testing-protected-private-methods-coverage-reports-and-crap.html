<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"> <meta name="description" content="Juan Treminio - Dallas based senior web developer"> <meta name="keywords" content=""> <meta property="og:title" content="Unit Testing Tutorial Part III: Testing Protected/Private Methods, Coverage Reports and CRAP - Juan Treminio - Senior Web Developer Blog"> <meta property="og:type" content="article"> <meta property="og:description" content=" This is Part III of a multi-part series. Below are the links to other parts of this tutorial! Unit Testing Tutorial Part I: Introduction to PHPUnit Unit Testing Tutorial Part II: Ass..."> <meta property="article:tag" content="webdev"> <meta property="article:tag" content="tutorial"> <meta property="article:tag" content="phpunit"> <meta property="article:tag" content="php"> <meta property="article:tag" content="testing"> <meta property="og:url" content="https://jtreminio.com/blog/unit-testing-tutorial-part-iii-testing-protected-private-methods-coverage-reports-and-crap"> <meta property="og:site_name" content="Juan Treminio - Senior Web Developer Blog"> <title>Unit Testing Tutorial Part III: Testing Protected/Private Methods, Coverage Reports and CRAP - Juan Treminio - Senior Web Developer Blog</title> <link rel="shortcut icon" type="image/png" href="/static/favicon/favicon.ico"/> <link rel="shortcut icon" type="image/png" href="/static/favicon/favicon-96x96.png" sizes="96x96"/> <link rel="shortcut icon" type="image/png" href="/static/favicon/favicon-32x32.png" sizes="32x32"/> <link rel="canonical" href="https://jtreminio.com/blog/unit-testing-tutorial-part-iii-testing-protected-private-methods-coverage-reports-and-crap"> <link href="//cdn.jsdelivr.net/npm/bootstrap-no-fonts-no-js@3.3.7/css/bootstrap.min.css" rel="stylesheet" type="text/css"/> <link href="//cdnjs.cloudflare.com/ajax/libs/startbootstrap-clean-blog/3.3.7/css/clean-blog.min.css" rel="stylesheet" type="text/css"/> <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/> <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/> <script src="//cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script> <link rel="stylesheet" href="/static/css/rouge.css"/> <link rel="stylesheet" href="/static/css/custom.css?1642997114"/> <link rel="stylesheet" href="/static/css/dark.css?1642997114" data-style="dark"/> </head> <body> <nav class="navbar navbar-default navbar-expand-md navbar-custom navbar-fixed-top is-fixed is-visible"> <div class="container-fluid"> <div class="navbar-header page-scroll"> <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar-collapse"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand hidden-xs hidden-sm" href="/">Juan Treminio - Senior Web Developer Blog</a> <a class="navbar-brand visible-xs visible-sm" href="/">Juan Treminio - Developer Blog</a> </div> <div class="collapse navbar-collapse" id="main-navbar-collapse"> <ul class="nav navbar-nav navbar-right"> <li><a href="/">Blog</a></li> <li><a href="/about">About</a></li> <li><a href="/hire-me">Hire Me</a></li> <li> <a class="btn theme-toggle"> <span class="theme-dark"><i data-feather="moon"></i> Dark Theme</span> <span class="theme-light"><i data-feather="sun"></i> Light Theme</span> </a> </li> </ul> </div> </div> </nav> <header class="intro-header"> <div class="container"> <div class="row"> <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"> <div class="post-heading"> <h1>Unit Testing Tutorial Part III: Testing Protected/Private Methods, Coverage Reports and CRAP</h1> <h2 class="subheading">PHP Unit introduction series</h2> <span class="meta">Posted on Mar 03, 2013 <br/> <i class="feather icon-tag"></i>Tags <a href="/tags#webdev">webdev</a>, <a href="/tags#tutorial">tutorial</a>, <a href="/tags#phpunit">phpunit</a>, <a href="/tags#php">php</a>, <a href="/tags#testing">testing</a> </span> </div> </div> </div> </div> </header> <article> <div class="container"> <div class="row"> <div class="post col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"> <blockquote class="success"> <p>This is Part III of a multi-part series. Below are the links to other parts of this tutorial!</p> <ul> <li><a href="/blog/unit-testing-tutorial-part-i-introduction-to-phpunit">Unit Testing Tutorial Part I: Introduction to PHPUnit</a></li> <li><a href="/blog/unit-testing-tutorial-part-ii-assertions-writing-a-useful-test-and-dataprovider">Unit Testing Tutorial Part II: Assertions, Writing a Useful Test and @dataProvider</a></li> <li>Unit Testing Tutorial Part III: Testing Protected/Private Methods, Coverage Reports and CRAP</li> <li><a href="/blog/unit-testing-tutorial-part-iv-mock-objects-stub-methods-and-dependency-injection">Unit Testing Tutorial Part IV: Mock Objects, Stub Methods and Dependency Injection</a></li> <li><a href="/blog/unit-testing-tutorial-part-v-mock-methods-and-overriding-constructors">Unit Testing Tutorial Part V: Mock Methods and Overriding Constructors</a></li> </ul> </blockquote> <p>A common question I keep hearing repeated is, “How much do I test?”.</p> <p>A common response is, “Until you have 100% code coverage.”.</p> <p>In this third part of my unit testing tutorial, I will explain what code coverage is and why 100% of it may not be what you should aim for.</p> <p>But first, how to test your private/protected methods!</p> <h3 id="protectedprivate-method-testing">PROTECTED/PRIVATE METHOD TESTING</h3> <p>If you look at the second part of this series, you will notice that we instantiate our class to be tested via a regular <code class="language-plaintext highlighter-rouge">new</code> call. You may also be left wondering how to test protected or private methods if you are unable to access them directly via the instantiated object ( <code class="language-plaintext highlighter-rouge">$url-&gt;someProtectedMethod()</code> ).</p> <p>Usually the answer would be, “You do not test protected/private methods directly.”. Since anything non-public is only accessible within the scope of the class, we assume that your class’s public methods (its API) will interact with them, so in the end you are actually indirectly testing these methods anyway.</p> <p>Of course, there are always exceptions to the rule: What if you are testing an abstract class that defines a protected methods but does not actually interact with it?</p> <p>What if you want to test different scenarios for a particular method and do not have the opportunity to go through your public methods?</p> <p>I will explain the process!</p> <h4 id="stupid-user-class">Stupid user class</h4> <p>Create a new file at <code class="language-plaintext highlighter-rouge">./phpUnitTutorial/User.php</code> and paste the following:</p> <blockquote class="danger"> <p>Let me be very clear: the <code class="language-plaintext highlighter-rouge">User</code> class is <em>not</em> a good class. Using <code class="language-plaintext highlighter-rouge">md5()</code> for passwords should be avoided at all costs! In fact, it is a pretty bad class overall. That said, it provides a very simple and easy to grasp example of what I am teaching.</p> </blockquote> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">phpUnitTutorial</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">MIN_PASS_LENGTH</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

    <span class="k">private</span> <span class="nv">$user</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user</span> <span class="o">=</span> <span class="nv">$user</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">getUser</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">setPassword</span><span class="p">(</span><span class="nv">$password</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$password</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">self</span><span class="o">::</span><span class="no">MIN_PASS_LENGTH</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">cryptPassword</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>

        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">cryptPassword</span><span class="p">(</span><span class="nv">$password</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>Our test would instantiate the User class using <code class="language-plaintext highlighter-rouge">$user = new User($details);</code>.</p> <p>You can access the <code class="language-plaintext highlighter-rouge">::setPassword()</code> method, but are unable to call <code class="language-plaintext highlighter-rouge">::cryptPassword()</code> - but in this case, you do not have to! The fact that your public method interacts with the private method is enough to say, “This method is tested.”, at least with this particular code!</p> <p>So, how would you create your test for this method? You can see the constructor and <code class="language-plaintext highlighter-rouge">::setPassword()</code> methods both require a parameter. PHPUnit requires no special magic to work with method parameters, as you will soon see.</p> <h4 id="creating-your-test">Creating your test</h4> <p>Create your empty test at <code class="language-plaintext highlighter-rouge">./phpUnitTutorial/Test/UserTest.php</code> and setup the skeleton:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">phpUnitTutorial\Test</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">UserTest</span> <span class="k">extends</span> <span class="err">\</span><span class="n">PHPUnit_Framework_TestCase</span>
<span class="p">{</span>
    <span class="c1">//</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>Running your test suite will result in an error:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>1) Warning
No tests found in class "phpUnitTutorial\Test\UserTest".
</pre></td></tr></tbody></table></code></pre></div></div> <p>This is great because it tells us PHPUnit has picked up this test and it is ready for actual code!</p> <p>We should identify what we would like to test before we go any further. As the <code class="language-plaintext highlighter-rouge">phpUnitTutorial\User</code> class is very simple, we can quickly see two scenarios:</p> <ol> <li><code class="language-plaintext highlighter-rouge">::setPassword()</code> returns <code class="language-plaintext highlighter-rouge">true</code> when password is set, and</li> <li><code class="language-plaintext highlighter-rouge">::getUser()</code> returns the user array, which would contain the new password which we would then compare against expected result.</li> </ol> <p>We will start with <code class="language-plaintext highlighter-rouge">::setPassword()</code> returning <code class="language-plaintext highlighter-rouge">true</code>. Create the empty method:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">testSetPasswordReturnsTrueWhenPasswordSuccessfullySet</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">phpUnitTutorial\User</code> constructor is expecting a parameter, so define it before instantiating the object:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">phpUnitTutorial\Test</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">phpUnitTutorial\User</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">UserTest</span> <span class="k">extends</span> <span class="err">\</span><span class="n">PHPUnit_Framework_TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testSetPasswordReturnsTrueWhenPasswordSuccessfullySet</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$details</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

        <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="p">(</span><span class="nv">$details</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>Note I have added a <code class="language-plaintext highlighter-rouge">use</code> statement.</p> <p>We will now define the parameter required for the <code class="language-plaintext highlighter-rouge">::setPassword()</code> method, and then call it:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">testSetPasswordReturnsTrueWhenPasswordSuccessfullySet</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$details</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="p">(</span><span class="nv">$details</span><span class="p">);</span>

    <span class="nv">$password</span> <span class="o">=</span> <span class="s1">'fubar'</span><span class="p">;</span>

    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="nf">setPassword</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>We expect <code class="language-plaintext highlighter-rouge">$result</code> to equal <code class="language-plaintext highlighter-rouge">true</code>, and I know just the assertion to use, <code class="language-plaintext highlighter-rouge">assertTrue()</code>! Here is our completed test:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">testSetPasswordReturnsTrueWhenPasswordSuccessfullySet</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$details</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="p">(</span><span class="nv">$details</span><span class="p">);</span>

    <span class="nv">$password</span> <span class="o">=</span> <span class="s1">'fubar'</span><span class="p">;</span>

    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="nf">setPassword</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertTrue</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>If you run your test suite, you will get a nice green bar for your troubles.</p> <p>We can now focus on testing <code class="language-plaintext highlighter-rouge">::getUser()</code>, which is a one-line method so it should be very simple to test, right? Well… not exactly. You see, the whole reason to even test <code class="language-plaintext highlighter-rouge">::getUser()</code> is to give us access to the private, and therefor inaccessible <code class="language-plaintext highlighter-rouge">$user</code> property. We want to verify that the <code class="language-plaintext highlighter-rouge">$user</code> property has values that we expect - like passwords structured in the correct way.</p> <p>What this means is that by testing <code class="language-plaintext highlighter-rouge">::getUser()</code> we are also going to end up testing <code class="language-plaintext highlighter-rouge">::__construct()</code>, <code class="language-plaintext highlighter-rouge">::setPassword()</code> and <code class="language-plaintext highlighter-rouge">::cryptPassword()</code>.</p> <p>Here is our empty test:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">testGetUserReturnsUserWithExpectedValues</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>The only thing we can really test in our particular scenario is that the password that was created by <code class="language-plaintext highlighter-rouge">::cryptPassword()</code> matches our expectations. First, set up the method similar to how we did with <code class="language-plaintext highlighter-rouge">::testSetPasswordReturnsTrueWhenPasswordSuccessfullySet()</code>:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">testGetUserReturnsUserWithExpectedValues</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$details</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="p">(</span><span class="nv">$details</span><span class="p">);</span>

    <span class="nv">$password</span> <span class="o">=</span> <span class="s1">'fubar'</span><span class="p">;</span>

    <span class="nv">$user</span><span class="o">-&gt;</span><span class="nf">setPassword</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>We do not catch the result of <code class="language-plaintext highlighter-rouge">::setPassword()</code> because we are going to assume it passed. If it did not pass, we will know for sure in the next steps.</p> <p>We know our raw password is <code class="language-plaintext highlighter-rouge">fubar</code>. We can see that this password is “hashed” in <code class="language-plaintext highlighter-rouge">::setPassword()</code> using <code class="language-plaintext highlighter-rouge">md5()</code>. Therefor we can define what we expect our result to actually be:</p> <p><code class="language-plaintext highlighter-rouge">$expectedPasswordResult = '5185e8b8fd8a71fc80545e144f91faf2';</code></p> <p>We then call <code class="language-plaintext highlighter-rouge">::getUser()</code> to get the user in its current state:</p> <p><code class="language-plaintext highlighter-rouge">$currentUser = $user-&gt;getUser();</code></p> <p>What are we expecting our test to actually do?</p> <p>We are expecting <code class="language-plaintext highlighter-rouge">::getUser()</code> to return an array, and we want to compare the <code class="language-plaintext highlighter-rouge">password</code> key to our expected value. The perfect assertion for this would be <code class="language-plaintext highlighter-rouge">assertEquals()</code>. Here is our completed test:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">testGetUserReturnsUserWithExpectedValues</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$details</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="p">(</span><span class="nv">$details</span><span class="p">);</span>

    <span class="nv">$password</span> <span class="o">=</span> <span class="s1">'fubar'</span><span class="p">;</span>

    <span class="nv">$user</span><span class="o">-&gt;</span><span class="nf">setPassword</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>

    <span class="nv">$expectedPasswordResult</span> <span class="o">=</span> <span class="s1">'5185e8b8fd8a71fc80545e144f91faf2'</span><span class="p">;</span>

    <span class="nv">$currentUser</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="nf">getUser</span><span class="p">();</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="nv">$expectedPasswordResult</span><span class="p">,</span> <span class="nv">$currentUser</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>PHPUnit seems to have liked our test:</p> <p><code class="language-plaintext highlighter-rouge">OK (9 tests, 9 assertions)</code></p> <h4 id="targeting-privateprotected-methods-directly">Targeting private/protected methods directly</h4> <p>What if we simply want to write more scenarios for a protected method? What if we do not want to go through the public API directly, and instead want to interact solely with the protected method?</p> <p>There are scenarios where this would be a legitimate need. I will not go through those possible scenarios today (I will in an upcoming part of my series!), but suffice it to say that with a little creative thinking, you can access your instantiated objects’ privates rather easily:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="cd">/**
 * Call protected/private method of a class.
 *
 * @param object &amp;$object    Instantiated object that we will run method on.
 * @param string $methodName Method name to call
 * @param array  $parameters Array of parameters to pass into method.
 *
 * @return mixed Method return.
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">invokeMethod</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$object</span><span class="p">,</span> <span class="nv">$methodName</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$parameters</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
<span class="p">{</span>
    <span class="nv">$reflection</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">ReflectionClass</span><span class="p">(</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$object</span><span class="p">));</span>
    <span class="nv">$method</span> <span class="o">=</span> <span class="nv">$reflection</span><span class="o">-&gt;</span><span class="nf">getMethod</span><span class="p">(</span><span class="nv">$methodName</span><span class="p">);</span>
    <span class="nv">$method</span><span class="o">-&gt;</span><span class="nf">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$method</span><span class="o">-&gt;</span><span class="nf">invokeArgs</span><span class="p">(</span><span class="nv">$object</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>Using <code class="language-plaintext highlighter-rouge">invokeMethod()</code> you can easily call your private or protected methods directly without having to go through public methods.</p> <p>To use, you simply do</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">invokeMethod</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="s1">'cryptPassword'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'passwordToCrypt'</span><span class="p">));</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>This would be the equivalent of simply typing</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="nf">cryptPassword</span><span class="p">(</span><span class="s1">'passwordToCrypt'</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>assuming <code class="language-plaintext highlighter-rouge">::cryptPassword()</code> were public.</p> <h3 id="coverage-report">COVERAGE REPORT</h3> <p>Imagine you have a large codebase, as well as several hundred unit tests. You are confident that most of your code is well-tested, but you need to make sure.</p> <p>You could go through each test and manually verify that every bit of your codebase is covered, but that sounds boring, and like a lot of work. Programmers love being lazy, and thankfully there is a very powerful tool that ships with PHPUnit that allows us to continue being lazy!</p> <p>The coverage report tool generates static HTML files for you to browse through and immediately see statistics of your codebase, including how much is covered by tests and how complicated your code is.</p> <p>It will even tell you if you have missed any possible routes through our tested code, like not triggering an <code class="language-plaintext highlighter-rouge">if</code> statement and running the code inside the block, for example.</p> <h4 id="generating-a-coverage-report">Generating a coverage report</h4> <p>To generate, simply pass the <code class="language-plaintext highlighter-rouge">--coverage-html</code> flag to PHPUnit, along with the destination to have the files generated. I usually use a folder <code class="language-plaintext highlighter-rouge">coverage</code>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>./vendor/bin/phpunit --coverage-html coverage
</pre></td></tr></tbody></table></code></pre></div></div> <div class="text-center"> <figure class="img-thumbnail"> <a href="/static/post/2013-03-03-unit-testing-tutorial-part-iii-testing-protected-private-methods-coverage-reports-and-crap/01-coverage-report.png"> <img style="max-width: 100%; height: auto;" src="/static/post/2013-03-03-unit-testing-tutorial-part-iii-testing-protected-private-methods-coverage-reports-and-crap/01-coverage-report.png" width="300px"/> <figcaption> <small>01-coverage-report.png</small> </figcaption> </a> </figure> </div> <p>If you look at your filesystem now, you will see that a <code class="language-plaintext highlighter-rouge">coverage</code> folder has been created and filled with HTML files. Open the <code class="language-plaintext highlighter-rouge">index.html</code> file and you will see:</p> <div class="text-center"> <figure class="img-thumbnail"> <a href="/static/post/2013-03-03-unit-testing-tutorial-part-iii-testing-protected-private-methods-coverage-reports-and-crap/02-coverage-report-dashboard.png"> <img style="max-width: 100%; height: auto;" src="/static/post/2013-03-03-unit-testing-tutorial-part-iii-testing-protected-private-methods-coverage-reports-and-crap/02-coverage-report-dashboard.png" width="300px"/> <figcaption> <small>02-coverage-report-dashboard.png</small> </figcaption> </a> </figure> </div> <p>[message info]If you are using an older PHPUnit version, it may look slightly different as the CSS was changed in a recent update![/message]</p> <p>Ignore the <code class="language-plaintext highlighter-rouge">vendor</code> folder, focus instead on your own code. Click into <code class="language-plaintext highlighter-rouge">phpUnitTutorial</code> and you will see two entries for the two files you currently have.</p> <h4 id="wait-only-2">Wait, only 2?</h4> <p>That is right, astute reader! You actually have 3 test files, and one of them is not listed on this page: <code class="language-plaintext highlighter-rouge">StupidTest.php</code>. That is because this test does not actually correspond to any code within our codebase, so PHPUnit did not generate a coverage report for it.</p> <h4 id="url-test-coverage">URL test coverage</h4> <p>Click into <code class="language-plaintext highlighter-rouge">URL.php</code> in the coverage report, and you will see:</p> <div class="text-center"> <figure class="img-thumbnail"> <a href="/static/post/2013-03-03-unit-testing-tutorial-part-iii-testing-protected-private-methods-coverage-reports-and-crap/03-url.php-coverage-report.png"> <img style="max-width: 100%; height: auto;" src="/static/post/2013-03-03-unit-testing-tutorial-part-iii-testing-protected-private-methods-coverage-reports-and-crap/03-url.php-coverage-report.png" width="300px"/> <figcaption> <small>03-url.php-coverage-report.png</small> </figcaption> </a> </figure> </div> <p>Looking at the legend at the bottom of the page tells you that green is executed code, red is not executed, and yellow is dead code. In this particular example, all the lines with code are green. If you hover over one of the lines, a small info box will popup and show you which tests cover this particular line:</p> <div class="text-center"> <figure class="img-thumbnail"> <a href="/static/post/2013-03-03-unit-testing-tutorial-part-iii-testing-protected-private-methods-coverage-reports-and-crap/04-line-covered-by.png"> <img style="max-width: 100%; height: auto;" src="/static/post/2013-03-03-unit-testing-tutorial-part-iii-testing-protected-private-methods-coverage-reports-and-crap/04-line-covered-by.png" width="300px"/> <figcaption> <small>04-line-covered-by.png</small> </figcaption> </a> </figure> </div> <p>This code is really straightforward, so it may not have the impact to make you go, “Cool!”, but it gives you a taste of what is to come.</p> <h4 id="user-test-coverage">User test coverage</h4> <p>Go back a page and click into <code class="language-plaintext highlighter-rouge">User.php</code>:</p> <div class="text-center"> <figure class="img-thumbnail"> <a href="/static/post/2013-03-03-unit-testing-tutorial-part-iii-testing-protected-private-methods-coverage-reports-and-crap/05-uncovered-line.png"> <img style="max-width: 100%; height: auto;" src="/static/post/2013-03-03-unit-testing-tutorial-part-iii-testing-protected-private-methods-coverage-reports-and-crap/05-uncovered-line.png" width="300px"/> <figcaption> <small>05-uncovered-line.png</small> </figcaption> </a> </figure> </div> <p>Looking at this report, you can immediately tell that something is red.</p> <p>Specifically, the <code class="language-plaintext highlighter-rouge">if</code> statement inside <code class="language-plaintext highlighter-rouge">::setPassword()</code> never resolves to <code class="language-plaintext highlighter-rouge">true</code> in any of our tests, so the code inside of it is never run.</p> <p>For this particular <code class="language-plaintext highlighter-rouge">if</code> statement, the contents are extremely simple: it returns <code class="language-plaintext highlighter-rouge">false</code>.</p> <p>Go back to <code class="language-plaintext highlighter-rouge">phpUnitTutorial\Test\UserTest</code> and create a new method to test this scenario:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">testSetPasswordReturnsFalseWhenPasswordLengthIsTooShort</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>In a previous test, <code class="language-plaintext highlighter-rouge">::testSetPasswordReturnsTrueWhenPasswordSuccessfullySet()</code>, the password we passed in to <code class="language-plaintext highlighter-rouge">::setPassword()</code> was 5 characters in length. To trigger the <code class="language-plaintext highlighter-rouge">if</code> block, we need to pass in a password that is less than 4 characters in length. The rest is pretty much the same as before:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">testSetPasswordReturnsFalseWhenPasswordLengthIsTooShort</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$details</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="p">(</span><span class="nv">$details</span><span class="p">);</span>

    <span class="nv">$password</span> <span class="o">=</span> <span class="s1">'fub'</span><span class="p">;</span>

    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="nf">setPassword</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>We are expecting <code class="language-plaintext highlighter-rouge">$result</code> to be <code class="language-plaintext highlighter-rouge">false</code>. There is an assertion for that! <code class="language-plaintext highlighter-rouge">assertFalse()</code> returns <code class="language-plaintext highlighter-rouge">true</code> if the value you pass it is <code class="language-plaintext highlighter-rouge">false</code>. Here is our completed test:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">testSetPasswordReturnsFalseWhenPasswordLengthIsTooShort</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$details</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="p">(</span><span class="nv">$details</span><span class="p">);</span>

    <span class="nv">$password</span> <span class="o">=</span> <span class="s1">'fub'</span><span class="p">;</span>

    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="nf">setPassword</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertFalse</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>Run your test suite and you get <code class="language-plaintext highlighter-rouge">OK (10 tests, 10 assertions)</code>.</p> <p>Re-run your coverage report, reload the page, and you should now see that red line has turned to green. If you hover over it, it will tell you this new test now covers it.</p> <div class="text-center"> <figure class="img-thumbnail"> <a href="/static/post/2013-03-03-unit-testing-tutorial-part-iii-testing-protected-private-methods-coverage-reports-and-crap/06-user.php-coverage-report.png"> <img style="max-width: 100%; height: auto;" src="/static/post/2013-03-03-unit-testing-tutorial-part-iii-testing-protected-private-methods-coverage-reports-and-crap/06-user.php-coverage-report.png" width="300px"/> <figcaption> <small>06-user.php-coverage-report.png</small> </figcaption> </a> </figure> </div> <h3 id="pay-attention-to-your-crap">PAY ATTENTION TO YOUR CRAP</h3> <p>If you look at the top of your coverage reports, you will see a column labeled “CRAP”.</p> <p>Officially it stands for “Change Risk Analysis and Predictions”, but I like to think of it as how hard it will be to come back to a particular method in the future and figure out what exactly is going on.</p> <p><a href="http://www.artima.com/weblogs/viewpost.jsp?thread=210575">A thorough description of the CRAP index can be found here</a>.</p> <p>I would not blame you for quickly closing that link. It is a bit dry, maybe a little boring if you are not really interested in the intricacies of what the CRAP index is.</p> <p>Suffice it to say, the higher your method’s CRAP index, the harder it is to understand.</p> <p>If your code is extremely simple - is little more than a getter, then its CRAP index is close to 1 (1 being the lowest value possible). If your code is a little more complex, say with a few <code class="language-plaintext highlighter-rouge">if</code> blocks, your CRAP value starts creeping up.</p> <p>If you throw a few <code class="language-plaintext highlighter-rouge">foreach</code> and nested statements, your CRAP will shoot right up!</p> <p>As you write tests to cover the different execution pathways your CRAP index will start climbing down. Once the method is fully covered, the final number will usually be much lower than the number shown when no tests cover it.</p> <p>So far our code has been fairly simple and to the point. There are not very many different pathways of execution, keeping our CRAP fairly low. This is the way I prefer to code: small, but plentiful methods doing very specific tasks. Not only is this much easier for a human to comprehend, but it allows more versatile refactoring of code while still allowing your tests to continue passing.</p> <h3 id="100-code-coverage-and-why-it-is-not-needed">100% CODE COVERAGE AND WHY IT IS NOT NEEDED</h3> <p>Many developers espouse the notion of writing unit tests until you have complete, 100% coverage. The arguments sound eerily similar to the tabs vs spaces crowd, so I tried lightly.</p> <p>I do not believe 100% code coverage is needed: if your method has a CRAP index &lt; 5, it is not complex enough to warrant a test.</p> <p>That said, a method with a CRAP index &lt; 5 is probably simple enough that a test for it would take less than 5 minutes to write, so the decision of how much time you want to dedicate to writing basic tests is ultimately up to you!</p> <h3 id="wrapping-up">WRAPPING UP</h3> <p>Today you learned that testing private/protected methods can be done either indirectly, or “cheating” using the <code class="language-plaintext highlighter-rouge">ReflectionClass</code> class.</p> <p>You also learned how to use the amazingly useful code coverage generator to track down code that had not been covered, and I possibly convinced you that writing 100% test coverage is unnecessary.</p> <p>I believe we are finally at the stage that we can introduce more advanced concepts, like mock objects and mock/stub methods, the awesomeness (and necessity) that is dependency injection and/or service container and tracking down unforeseen issues when refactoring code.</p> <p>All that and more is coming up in my next chapter!</p> <p>Until next time, this is Señor PHP Developer Juan Treminio wishing you adios!</p> <hr class="invisible"> <ul class="pager"> <li class="previous"> <a href="/blog/unit-testing-tutorial-part-ii-assertions-writing-a-useful-test-and-dataprovider" data-toggle="tooltip" data-placement="top" title="Unit Testing Tutorial Part II: Assertions, Writing a Useful Test and @dataProvider"> Previous &rarr;<br> <span>Unit Testing Tutorial Part II: Assertions, Writing a Useful Test and @dataProvider</span> </a> </li> <li class="next"> <a href="/blog/unit-testing-tutorial-part-iv-mock-objects-stub-methods-and-dependency-injection" data-toggle="tooltip" data-placement="top" title="Unit Testing Tutorial Part IV: Mock Objects, Stub Methods and Dependency Injection"> &larr; Next<br> <span>Unit Testing Tutorial Part IV: Mock Objects, Stub Methods and Dependency Injection</span> </a> </li> </ul> <hr class="invisible"> </div> </div> </div> </article> <footer> <div class="container"> <div class="row"> <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"> <ul class="list-inline text-center footer-icons"> <li><a href="mailto:jtreminio@gmail.com"><i data-feather="mail"></i></a></li> <li> <a href="https://github.com/jtreminio" target="_blank"> <i data-feather="github"></i> </a> </li> <li> <a href="https://twitter.com/juantreminio" target="_blank"> <i data-feather="twitter"></i> </a> </li> <li> <a href="https://www.linkedin.com/in/jtreminio-1" target="_blank"> <i data-feather="linkedin"></i> </a> </li> </ul> </div> </div> </div> </footer> <link href="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" rel="stylesheet" type="text/css"/> <link href="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" rel="stylesheet" type="text/css"/> <script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js"></script> <script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js"></script> <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"> <div class="pswp__bg"></div> <div class="pswp__scroll-wrap"> <div class="pswp__container"> <div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div> </div> <div class="pswp__ui pswp__ui--hidden"> <div class="pswp__top-bar"> <div class="pswp__counter"></div> <button class="pswp__button pswp__button--close" title="Close (Esc)"></button> <button class="pswp__button pswp__button--share" title="Share"></button> <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button> <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button> <div class="pswp__preloader"> <div class="pswp__preloader__icn"> <div class="pswp__preloader__cut"> <div class="pswp__preloader__donut"></div> </div> </div> </div> </div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"> <div class="pswp__share-tooltip"></div> </div> <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"> </button> <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"> </button> <div class="pswp__caption"> <div class="pswp__caption__center"></div> </div> </div> </div> </div> </body> <script src="/static/js/custom.js?1642997114"></script> </html>