<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"> <meta name="description" content="Juan Treminio - Dallas based senior web developer"> <meta name="keywords" content=""> <meta property="og:title" content="Unit Testing Tutorial Part V: Mock Methods and Overriding Constructors - Juan Treminio - Senior Web Developer Blog"> <meta property="og:type" content="article"> <meta property="og:description" content=" This is Part V of a multi-part series. Below are the links to other parts of this tutorial! Unit Testing Tutorial Part I: Introduction to PHPUnit Unit Testing Tutorial Part II: Asser..."> <meta property="article:tag" content="webdev"> <meta property="article:tag" content="tutorial"> <meta property="article:tag" content="phpunit"> <meta property="article:tag" content="php"> <meta property="article:tag" content="testing"> <meta property="og:url" content="https://jtreminio.com/blog/unit-testing-tutorial-part-v-mock-methods-and-overriding-constructors/"> <meta property="og:site_name" content="Juan Treminio - Senior Web Developer Blog"> <title>Unit Testing Tutorial Part V: Mock Methods and Overriding Constructors - Juan Treminio - Senior Web Developer Blog</title> <link rel="shortcut icon" type="image/png" href="/static/favicon/favicon.ico"/> <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-touch-icon.png"> <link rel="shortcut icon" type="image/png" href="/static/favicon/favicon-96x96.png" sizes="96x96"/> <link rel="shortcut icon" type="image/png" href="/static/favicon/favicon-32x32.png" sizes="32x32"/> <link rel="shortcut icon" type="image/png" href="/static/favicon/favicon-16x16.png" sizes="16x16"/> <link rel="canonical" href="https://jtreminio.com/blog/unit-testing-tutorial-part-v-mock-methods-and-overriding-constructors/"> <link href="//cdn.jsdelivr.net/npm/bootstrap-no-fonts-no-js@3.3.7/css/bootstrap.min.css" rel="stylesheet" type="text/css"/> <link href="//cdnjs.cloudflare.com/ajax/libs/startbootstrap-clean-blog/3.3.7/css/clean-blog.min.css" rel="stylesheet" type="text/css"/> <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/> <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/> <script src="//cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script> <link rel="stylesheet" href="/static/css/rouge.css"/> <link rel="stylesheet" href="/static/css/custom.css"/> <link rel="stylesheet" href="/static/css/dark.css" data-dark-style/> </head> <body> <nav class="navbar navbar-default navbar-expand-md navbar-custom navbar-fixed-top is-fixed is-visible"> <div class="container-fluid"> <div class="navbar-header page-scroll"> <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar-collapse"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand hidden-xs hidden-sm" href="/">Juan Treminio - Senior Web Developer Blog</a> <a class="navbar-brand visible-xs visible-sm" href="/">Juan Treminio - Developer Blog</a> </div> <div class="collapse navbar-collapse" id="main-navbar-collapse"> <ul class="nav navbar-nav navbar-right"> <li><a href="/">Blog</a></li> <li><a href="/about/">About</a></li> <li><a href="/hire-me/">Hire Me</a></li> <li> <a class="btn theme-toggle"> <span class="theme-dark"><i data-feather="moon"></i> Dark Theme</span> <span class="theme-light"><i data-feather="sun"></i> Light Theme</span> </a> </li> </ul> </div> </div> </nav> <header class="intro-header"> <div class="container"> <div class="row"> <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"> <div class="post-heading"> <h1>Unit Testing Tutorial Part V: Mock Methods and Overriding Constructors</h1> <h2 class="subheading">PHP Unit introduction series</h2> <div class="meta">Posted on Mar 31, 2013 <br/> <span> <i data-feather="tag" alt="tags"></i> <a href="/tags#webdev">webdev</a>, <a href="/tags#tutorial">tutorial</a>, <a href="/tags#phpunit">phpunit</a>, <a href="/tags#php">php</a>, <a href="/tags#testing">testing</a> </span> </div> </div> </div> </div> </div> </header> <article> <div class="container"> <div class="row"> <div class="post col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"> <blockquote class="success"> <p>This is Part V of a multi-part series. Below are the links to other parts of this tutorial!</p> <ul> <li><a href="/blog/unit-testing-tutorial-part-i-introduction-to-phpunit/">Unit Testing Tutorial Part I: Introduction to PHPUnit</a></li> <li><a href="/blog/unit-testing-tutorial-part-ii-assertions-writing-a-useful-test-and-dataprovider/">Unit Testing Tutorial Part II: Assertions, Writing a Useful Test and @dataProvider</a></li> <li><a href="/blog/unit-testing-tutorial-part-iii-testing-protected-private-methods-coverage-reports-and-crap/">Unit Testing Tutorial Part III: Testing Protected/Private Methods, Coverage Reports and CRAP</a></li> <li><a href="/blog/unit-testing-tutorial-part-iv-mock-objects-stub-methods-and-dependency-injection/">Unit Testing Tutorial Part IV: Mock Objects, Stub Methods and Dependency Injection</a></li> <li>Unit Testing Tutorial Part V: Mock Methods and Overriding Constructors</li> </ul> </blockquote> <p>Previously in my PHPUnit tutorial series, you learned about the very powerful concept of mock objects and stub methods. This concept is central to successful unit testing, and once it fully ‘clicks’ in your head you will start to realize how useful and simple testing can be.</p> <p>There is also another thing I want to make clear: creating tests is basically a puzzle</p> <ul> <li>you simply have to go step by step, making sure all the pieces fit together correctly so you can get your green. I hope to make clear what I mean by the end of this tutorial.</li> </ul> <h2 id="introducing-mock-methods">INTRODUCING MOCK METHODS</h2> <p><a href="/blog/unit-testing-tutorial-part-iv-mock-objects-stub-methods-and-dependency-injection/">In my previous tutorial</a> you learned all about mock objects and stub methods. There is another very similar concept you must also know about: mock methods.</p> <p>To recap:</p> <h3 id="mock-object">Mock Object</h3> <p>A mock object is an object that you would create using PHPUnit’s <code class="language-plaintext highlighter-rouge">getMockBuilder()</code> method. It is basically an object that extends the class you define and allows you to perform nifty tricks and assertions on it.</p> <h3 id="stub-method">Stub Method</h3> <p>A stub method is a method contained within a mock object that returns <code class="language-plaintext highlighter-rouge">null</code> by default, but allows you to easily override the return value.</p> <h3 id="mock-method">Mock Method</h3> <p>A mock method is pretty simple - it does the exact same thing its original method would. In other words any code that is in the method you are mocking will actually run and will not return <code class="language-plaintext highlighter-rouge">null</code> by default (unless that is what it originally did).</p> <p>Mark Nichols gives a very good explanation of what the <a href="http://marknic.net/2010/01/11/mocks-vs-stubs/">difference between mock and stub methods are</a>.</p> <p>Basically mock methods are useful for when you <em>want</em> the code inside of it to run, but also want to do some assertions on the behavior of the method. These assertions could be that specific parameters are passed to the method (if it applies), or that the method is called exactly 3 times or not at all.</p> <p>Do not worry if this does not make immediate sense yet.</p> <h2 id="the-four-pathways-of-getmockbuilder">THE FOUR PATHWAYS OF GETMOCKBUILDER()</h2> <p>We have already explored ways of using PHPUnit’s awesome <code class="language-plaintext highlighter-rouge">getMockBuilder()</code> API but did you know there are actually 4 different ways of creating the object? It all depends on your use, or non-use, of the <code class="language-plaintext highlighter-rouge">setMethods()</code> method.</p> <p>To illustrate the differences we will use the code from the previous article.</p> <h3 id="do-not-call-setmethods">Do not call setMethods()</h3> <p>This is the simplest way:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="nv">$authorizeNet</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getMockBuilder</span><span class="p">(</span><span class="s1">'\AuthorizeNetAIM'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">getMock</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>This produces a mock object where the methods</p> <ul> <li>Are all stubs,</li> <li>All return <code class="language-plaintext highlighter-rouge">null</code> by default,</li> <li>Are easily overridable</li> </ul> <h3 id="passing-an-empty-array">Passing an empty array</h3> <p>You can pass an empty array to <code class="language-plaintext highlighter-rouge">setMethods()</code>:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="nv">$authorizeNet</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getMockBuilder</span><span class="p">(</span><span class="s1">'\AuthorizeNetAIM'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">setMethods</span><span class="p">(</span><span class="k">array</span><span class="p">())</span>
    <span class="o">-&gt;</span><span class="nf">getMock</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>This produces a mock object that is exactly the same as if you have not called <code class="language-plaintext highlighter-rouge">setMethods()</code> at all. The methods</p> <ul> <li>Are all stubs,</li> <li>All return <code class="language-plaintext highlighter-rouge">null</code> by default,</li> <li>Are easily overridable</li> </ul> <h3 id="passing-null">Passing null</h3> <p>You can also pass <code class="language-plaintext highlighter-rouge">null</code>:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="nv">$authorizeNet</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getMockBuilder</span><span class="p">(</span><span class="s1">'\AuthorizeNetAIM'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">setMethods</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">getMock</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>This produces a mock object where the methods</p> <ul> <li>Are all mocks,</li> <li>Run the actual code contained within the method when called,</li> <li>Do not allow you to override the return value</li> </ul> <h3 id="passing-an-array-containing-method-names">Passing an array containing method names</h3> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="nv">$authorizeNet</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getMockBuilder</span><span class="p">(</span><span class="s1">'\AuthorizeNetAIM'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">setMethods</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'authorizeAndCapture'</span><span class="p">,</span> <span class="s1">'foobar'</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">getMock</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>This produces a mock object whose methods are a mix of the above three scenarios.</p> <p>The methods you have identified</p> <ul> <li>Are all stubs,</li> <li>All return <code class="language-plaintext highlighter-rouge">null</code> by default,</li> <li>Are easily overridable</li> </ul> <p>Methods you did not identify</p> <ul> <li>Are all mocks,</li> <li>Run the actual code contained within the method when called,</li> <li>Do not allow you to override the return value</li> </ul> <p>This means that in the <code class="language-plaintext highlighter-rouge">$authorizeNet</code> mock object the <code class="language-plaintext highlighter-rouge">::authorizeAndCapture()</code> and <code class="language-plaintext highlighter-rouge">::foobar()</code> methods would return <code class="language-plaintext highlighter-rouge">null</code> or you can override their return values, but any method within that class other than those two will run their original code.</p> <h2 id="why-would-you-want-mock-methods">WHY WOULD YOU WANT MOCK METHODS?</h2> <p>I will begin with a very simple example that you may have come across during your years as a developer:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">phpUnitTutorial</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">BadCode</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$user</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user</span> <span class="o">=</span> <span class="nv">$user</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">authorize</span><span class="p">(</span><span class="nv">$password</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">checkPassword</span><span class="p">(</span><span class="nv">$password</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">checkPassword</span><span class="p">(</span><span class="nv">$password</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="s1">'password'</span><span class="p">])</span> <span class="o">||</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]</span> <span class="o">!==</span> <span class="nv">$password</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s1">'YOU SHALL NOT PASS'</span><span class="p">;</span>
            <span class="k">exit</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>A very simple class showing a very simple problem: If a user’s password is not set, echo an error to the user and stop script execution.</p> <p>The problem with this class is that calling <code class="language-plaintext highlighter-rouge">exit</code> in your code will halt the current PHP execution, including any tests you may be running! That would be less than ideal.</p> <p>The optimal solution would be not having <code class="language-plaintext highlighter-rouge">exit</code> in your code at all. You should always try to return a value instead. If you are unable to do this, another solution would be to wrap the exit in a method and stub it:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="k">protected</span> <span class="k">function</span> <span class="n">checkPassword</span><span class="p">(</span><span class="nv">$password</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="s1">'password'</span><span class="p">])</span> <span class="o">||</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]</span> <span class="o">!==</span> <span class="nv">$password</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'YOU SHALL NOT PASS'</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">callExit</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="n">callExit</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">exit</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>Suddenly this class is testable, you only need to stub out the <code class="language-plaintext highlighter-rouge">callExit()</code> method!</p> <p>Here is our test:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">phpUnitTutorial\Test</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">BadCodeTest</span> <span class="k">extends</span> <span class="err">\</span><span class="n">PHPUnit_Framework_TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testAuthorizeExitsWhenPasswordNotSet</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'username'</span> <span class="o">=&gt;</span> <span class="s1">'jtreminio'</span><span class="p">);</span>
        <span class="nv">$password</span> <span class="o">=</span> <span class="s1">'foo'</span><span class="p">;</span>

        <span class="nv">$badCode</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getMockBuilder</span><span class="p">(</span><span class="s1">'phpUnitTutorial\BadCode'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">setConstructorArgs</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$user</span><span class="p">))</span>
            <span class="o">-&gt;</span><span class="nf">setMethods</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'callExit'</span><span class="p">))</span>
            <span class="o">-&gt;</span><span class="nf">getMock</span><span class="p">();</span>

        <span class="nv">$badCode</span><span class="o">-&gt;</span><span class="nf">expects</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">once</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="nf">method</span><span class="p">(</span><span class="s1">'callExit'</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">expectOutputString</span><span class="p">(</span><span class="s1">'YOU SHALL NOT PASS'</span><span class="p">);</span>

        <span class="nv">$badCode</span><span class="o">-&gt;</span><span class="nf">authorize</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>By passing <code class="language-plaintext highlighter-rouge">array('callExit')</code> into <code class="language-plaintext highlighter-rouge">setMethods()</code>, you have created a mock object with a mix of stub and mock methods. In this example <code class="language-plaintext highlighter-rouge">callExit()</code> is the only method to be stubbed - all others are proper mocks and will run the actual code behind them.</p> <p>Thanks to the magic of mock methods once your code reaches the point of <code class="language-plaintext highlighter-rouge">if (empty($this-&gt;user['password']) || $this-&gt;user['password'] !== $password) {</code> and calls <code class="language-plaintext highlighter-rouge">callExit()</code> your tests will not die since <code class="language-plaintext highlighter-rouge">callExit()</code> now returns <code class="language-plaintext highlighter-rouge">null</code> instead of actually running the <code class="language-plaintext highlighter-rouge">exit</code> line inside of it.</p> <p>If you stub multiple methods in a mock object you can call <code class="language-plaintext highlighter-rouge">expects()</code> as many times as you want. These are considered ‘soft’ assertions in PHPUnit and do not count toward the goal of having only a single assertion in your tests. If we remove the lines,</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="nv">$badCode</span><span class="o">-&gt;</span><span class="nf">expects</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">once</span><span class="p">())</span>
    <span class="o">-&gt;</span><span class="nf">method</span><span class="p">(</span><span class="s1">'callExit'</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>our test would still pass. However, since we have added the soft assertion if in the future our code failed to call <code class="language-plaintext highlighter-rouge">callExit()</code> our test would fail and we would immediately know something broke our code.</p> <p>If you attempt to define a return value for the <code class="language-plaintext highlighter-rouge">checkPassword()</code> method with <code class="language-plaintext highlighter-rouge">-&gt;will($this-&gt;returnValue('RETURN VALUE HERE!'));</code> PHPUnit will ignore them and continue on with the test. Remember - mock methods do not allow you to override the return value!</p> <h2 id="handling-bad-constructors">HANDLING BAD CONSTRUCTORS</h2> <p>Sometimes you come across legacy code that does the the unthinkable - its constructor goes beyond simply setting up object property values and actually <strong>does real work</strong>!</p> <p><a href="http://misko.hevery.com/code-reviewers-guide/flaw-constructor-does-real-work/">Miško Hevery lays down the law on why the constructor should be sissy</a> compared to the other methods in the class. It should do very little aside from simply setting object properties from its parameters.</p> <h3 id="an-example-of-bad-constructor-design">An example of bad constructor design</h3> <p>Create the file <code class="language-plaintext highlighter-rouge">./phpUnitTutorial/NaughtyConstructor.php</code> and paste the following:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">phpUnitTutorial</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">NaughtyConstructor</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$html</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">html</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">getMetaTags</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$mime</span> <span class="o">=</span> <span class="s1">'text/plain'</span><span class="p">;</span>
        <span class="nv">$filename</span> <span class="o">=</span> <span class="s2">"data://</span><span class="si">{</span><span class="nv">$mime</span><span class="si">}</span><span class="s2">;base64,"</span> <span class="mf">.</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">html</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">get_meta_tags</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">getTitle</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nb">preg_match</span><span class="p">(</span><span class="s2">"#&lt;title&gt;(.+)&lt;/title&gt;#siU"</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">html</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>

        <span class="k">return</span> <span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>This class structure mimics many classes you may come across every day. To use it, you would do the following:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="nv">$naughty</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NaughtyConstructor</span><span class="p">(</span><span class="s1">'http://jtreminio.com'</span><span class="p">);</span>
<span class="nv">$metaTags</span> <span class="o">=</span> <span class="nv">$naughty</span><span class="o">-&gt;</span><span class="nf">getMetaTags</span><span class="p">();</span>
<span class="nv">$title</span> <span class="o">=</span> <span class="nv">$naughty</span><span class="o">-&gt;</span><span class="nf">getTitle</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>Without scrolling down this article to cheat, can you point out the biggest reason this code can be considered bad news for testing?</p> <p>Answer: What if you attempt to run your test when you are not connected to the internet? Since you have created a dependency in your constructor on <code class="language-plaintext highlighter-rouge">file_get_contents()</code>, you are forced to always be online to have this test pass. Well, that kind of sucks! Tests should not rely on anything outside of themselves, and having a requirement that you be connected to the internet completely fails that point.</p> <p>Create a basic test for the code as it currently is, file <code class="language-plaintext highlighter-rouge">./phpUnitTutorial/Test/NaughtConstructorTest.php</code>:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">phpUnitTutorial\Test</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">phpUnitTutorial\NaughtyConstructor</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">NaughtyConstructorTest</span> <span class="k">extends</span> <span class="err">\</span><span class="n">PHPUnit_Framework_TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testGetMetaTagsReturnsArrayOfProperties</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$naughty</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NaughtyConstructor</span><span class="p">(</span><span class="s1">'http://jtreminio.com'</span><span class="p">);</span>

        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$naughty</span><span class="o">-&gt;</span><span class="nf">getMetaTags</span><span class="p">();</span>

        <span class="nv">$expectedAuthor</span> <span class="o">=</span> <span class="s1">'Juan Treminio'</span><span class="p">;</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span>
            <span class="nv">$expectedAuthor</span><span class="p">,</span>
            <span class="nv">$result</span><span class="p">[</span><span class="s1">'author'</span><span class="p">]</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>Before I run this simple test, I enable airplane mode on my laptop to kill the internet. Then I run the test using <code class="language-plaintext highlighter-rouge">$ ./vendor/bin/phpunit phpUnitTutorial/Test/NaughtyConstructorTest.php</code>. After a rather long, boring wait I finally get the results: Failure.</p> <table class="table img-link"> <thead> <tr> <th style="text-align: center"><img src="/static/post/2013-03-31-unit-testing-tutorial-part-v-mock-methods-and-overriding-constructors/01-internet-dependency.png" alt="01-internet-dependency.png"/></th> </tr> </thead> <tbody> <tr> <td style="text-align: center">01-internet-dependency.png</td> </tr> </tbody> </table> <p>You did not expect another result, did you?</p> <h3 id="before-we-proceed-some-potential-fixes">Before we proceed, some potential fixes</h3> <p>There are several ways of making this class much better but for now I want you to imagine that this particular class cannot be changed. We are only allowed to write a unit test for it, and are unable to touch anything in the class itself.</p> <p>If we <em>could</em> change the class, some possible fixes to this issue would be:</p> <ul> <li>Passing the HTML as a constructor parameter (ex <code class="language-plaintext highlighter-rouge">$naughty = new NaughtyConstructor($html);</code>),</li> <li>Using a locally accessible development URL (ex from your development VM),</li> <li>Moving the <code class="language-plaintext highlighter-rouge">file_get_contents()</code> function call outside of the constructor, and then stubbing the method</li> </ul> <p>For the purposes of this tutorial, though, we will not go down any of those routes.</p> <p>If you can read you already know we need to mock the constructor!</p> <h3 id="__construct-i-hereby-mock-thee">__construct(), I hereby mock thee!</h3> <p>Replace the first line in your test, <code class="language-plaintext highlighter-rouge">$naughty = new NaughtyConstructor('http://jtreminio.com');</code>, with PHPUnit’s <code class="language-plaintext highlighter-rouge">getMockBuilder()</code>:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="nv">$naughty</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getMockBuilder</span><span class="p">(</span><span class="s1">'\phpUnitTutorial\NaughtyConstructor'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">setMethods</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'__construct'</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">setConstructorArgs</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'http://jtreminio.com'</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">getMock</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>If you remember from earlier, whatever method you identify in <code class="language-plaintext highlighter-rouge">setMethods()</code> will be a stub, returning <code class="language-plaintext highlighter-rouge">null</code> by default.</p> <p>Except this time when you run your test it does not do that. Why?</p> <h3 id="you-cannot-stub-the-constructor">You cannot stub the constructor!</h3> <p>Think about it - a stub is a method that returns <code class="language-plaintext highlighter-rouge">null</code> by default. When you instantiate an object using <code class="language-plaintext highlighter-rouge">new</code> PHP magically returns a new instance of the class defined. So it would not make sense if you overwrote that magic and instead returned <code class="language-plaintext highlighter-rouge">null</code> instead of a new object, would it?</p> <p>PHPUnit has a fix in <code class="language-plaintext highlighter-rouge">disableOriginalConstructor()</code>:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="nv">$naughty</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getMockBuilder</span><span class="p">(</span><span class="s1">'\phpUnitTutorial\NaughtyConstructor'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">setMethods</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'__construct'</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">setConstructorArgs</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'http://jtreminio.com'</span><span class="p">))</span>
    <span class="o">-&gt;</span><span class="nf">disableOriginalConstructor</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">getMock</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>Note: passing <code class="language-plaintext highlighter-rouge">__construct</code> to the <code class="language-plaintext highlighter-rouge">setMethods()</code> method seems like it would be unnecessary - but remember that if you do not call <code class="language-plaintext highlighter-rouge">setMethods()</code> or if you pass an empty <code class="language-plaintext highlighter-rouge">array()</code> to <code class="language-plaintext highlighter-rouge">setMethods()</code> all methods in the object would be stubs that return <code class="language-plaintext highlighter-rouge">null</code>. That is not what we want!</p> <p>Run your test again and… Failure!</p> <table class="table img-link"> <thead> <tr> <th style="text-align: center"><img src="/static/post/2013-03-31-unit-testing-tutorial-part-v-mock-methods-and-overriding-constructors/02-removed-constructor-assignments.png" alt="02-removed-constructor-assignments.png"/></th> </tr> </thead> <tbody> <tr> <td style="text-align: center">02-removed-constructor-assignments.png</td> </tr> </tbody> </table> <p>Well of course it is failing - <code class="language-plaintext highlighter-rouge">getMetaTags();</code> tries to use <code class="language-plaintext highlighter-rouge">$this-&gt;html</code> which is empty because we disabled the constructor!</p> <p>This brings up another interesting point: what happens if we had tried to test a website that we do not control? We could happily test against their HTML for weeks, and then one day they redo their code and now no longer have an author meta tag to assert against, making our tests fail! This is another marks against having outside dependencies in your unit tests.</p> <p>The solution to our current dilemma is simply creating sample HTML in our test and then setting it in our code.</p> <p>Here is what your test should currently look like:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">phpUnitTutorial\Test</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">phpUnitTutorial\NaughtyConstructor</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">NaughtyConstructorTest</span> <span class="k">extends</span> <span class="err">\</span><span class="n">PHPUnit_Framework_TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testGetMetaTagsReturnsArrayOfProperties</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$naughty</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getMockBuilder</span><span class="p">(</span><span class="s1">'\phpUnitTutorial\NaughtyConstructor'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">setMethods</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'__construct'</span><span class="p">))</span>
            <span class="o">-&gt;</span><span class="nf">setConstructorArgs</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'http://jtreminio.com'</span><span class="p">))</span>
            <span class="o">-&gt;</span><span class="nf">disableOriginalConstructor</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="nf">getMock</span><span class="p">();</span>

        <span class="nv">$naughty</span><span class="o">-&gt;</span><span class="n">html</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getHtml</span><span class="p">();</span>

        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$naughty</span><span class="o">-&gt;</span><span class="nf">getMetaTags</span><span class="p">();</span>

        <span class="nv">$expectedAuthor</span> <span class="o">=</span> <span class="s1">'Juan Treminio'</span><span class="p">;</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span>
            <span class="nv">$expectedAuthor</span><span class="p">,</span>
            <span class="nv">$result</span><span class="p">[</span><span class="s1">'author'</span><span class="p">]</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">getHtml</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">'
             &lt;!DOCTYPE html&gt;
                &lt;html lang="en"&gt;
                &lt;head&gt;
                    &lt;meta name="viewport" content="width=1, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"/&gt;
                    &lt;meta name="description" content="Dallas PHP/MySQL Web Developer"/&gt;
                    &lt;meta name="author" content="Juan Treminio"/&gt;
                    &lt;meta name="generator" content="PieCrust 1.0.0-dev"/&gt;
                    &lt;meta name="template-engine" content="Twig"/&gt;
                    &lt;title&gt;Juan Treminio - Dallas PHP/MySQL Web Developer &amp;mdash; Blog&lt;/title&gt;
                &lt;/head&gt;
                &lt;body&gt;
                &lt;/body&gt;
                &lt;/html&gt;
        '</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>We have accomplished an important goal in unit testing: remove outside dependencies.</p> <p>Running our test now gives us a green bar!</p> <p>We can even add another test:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">testGetTitleReturnsExpectedTitle</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$naughty</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getMockBuilder</span><span class="p">(</span><span class="s1">'\phpUnitTutorial\NaughtyConstructor'</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="nf">setMethods</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'__construct'</span><span class="p">))</span>
        <span class="o">-&gt;</span><span class="nf">setConstructorArgs</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'http://jtreminio.com'</span><span class="p">))</span>
        <span class="o">-&gt;</span><span class="nf">disableOriginalConstructor</span><span class="p">()</span>
        <span class="o">-&gt;</span><span class="nf">getMock</span><span class="p">();</span>

    <span class="nv">$naughty</span><span class="o">-&gt;</span><span class="n">html</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getHtml</span><span class="p">();</span>

    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$naughty</span><span class="o">-&gt;</span><span class="nf">getTitle</span><span class="p">();</span>

    <span class="nv">$expectedTitle</span> <span class="o">=</span> <span class="s1">'Juan Treminio - Dallas PHP/MySQL Web Developer &amp;mdash; Blog'</span><span class="p">;</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span>
        <span class="nv">$expectedTitle</span><span class="p">,</span>
        <span class="nv">$result</span> 
    <span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>Green bar!</p> <h2 id="wrap-it-up">WRAP IT UP</h2> <p>Today you learned about the last piece of the mock puzzle: mock methods.</p> <p>Juggling the definitions of mock objects, stub methods and mock methods in your head can seem a little daunting at first but I am confident once you learn the differences between the three, and when you require mock methods over stub methods or vice-versa, you will become a better tester which will make you a better developer over-all.</p> <p>In the next part of this series I will introduce the concept of using a container in your tests, and how you can easily dominate a big ball of legacy mud with containers!</p> <p>In the meantime, you may want to brush up on containers themselves with my article, <a href="/blog/an-introduction-to-pimple-and-service-containers/">An introduction to Pimple and Service Containers</a>.</p> <p>Until next time, this is Señor PHP Developer Juan Treminio wishing you adios!</p> <hr class="invisible"> <ul class="pager"> <li class="previous"> <a href="/blog/unit-testing-tutorial-part-iv-mock-objects-stub-methods-and-dependency-injection/" data-toggle="tooltip" data-placement="top" title="Unit Testing Tutorial Part IV: Mock Objects, Stub Methods and Dependency Injection"> Previous &rarr;<br> <span>Unit Testing Tutorial Part IV: Mock Objects, Stub Methods and Dependency Injection</span> </a> </li> <li class="next"> <a href="/blog/introduction-to-vagrant-puppet-and-introducing-puphpet-a-simple-to-use-vagrant-puppet-gui-configurator/" data-toggle="tooltip" data-placement="top" title="Introduction to Vagrant/Puppet and introducing PuPHPet - A simple to use Vagrant/Puppet GUI Configurator!"> &larr; Next<br> <span>Introduction to Vagrant/Puppet and introducing PuPHPet - A simple to use Vagrant/Puppet GUI Configurator!</span> </a> </li> </ul> <hr class="invisible"> <div class="comment"> <script src="//utteranc.es/client.js" repo="jtreminio/jtreminio.github.io" issue-number="10" theme="photon-dark" crossorigin="anonymous" async></script> </div> </div> </div> </div> </article> <footer> <div class="container"> <div class="row"> <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"> <ul class="list-inline text-center footer-icons"> <li><a href="mailto:jtreminio@gmail.com"><i data-feather="mail"></i></a></li> <li> <a href="https://github.com/jtreminio" target="_blank"> <i data-feather="github"></i> </a> </li> <li> <a href="https://twitter.com/juantreminio" target="_blank"> <i data-feather="twitter"></i> </a> </li> <li> <a href="https://www.linkedin.com/in/jtreminio-1" target="_blank"> <i data-feather="linkedin"></i> </a> </li> </ul> </div> </div> </div> </footer> </body> <script src="/static/js/custom.js"></script> </html>